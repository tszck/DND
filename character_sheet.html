<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RPG Character Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="supabase.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #23272a;
      color: #fff;
      margin: 0;
      padding: 0;
    }
    .dashboard {
      max-width: 900px;
      margin: 40px auto;
      background: #2c2f33;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.4);
      padding: 32px;
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 32px;
    }
    .profile {
      text-align: center;
    }
    .profile img {
      width: 120px;
      border-radius: 50%;
      border: 4px solid #7289da;
      margin-bottom: 16px;
    }
    .profile h2 {
      margin: 0;
      font-size: 2em;
      color: #7289da;
    }
    .stats, .inventory, .abilities {
      margin-bottom: 24px;
    }
    .stats table {
      width: 100%;
      border-collapse: collapse;
    }
    .stats th, .stats td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #444;
    }
    .section-title {
      font-size: 1.2em;
      color: #43b581;
      margin-bottom: 8px;
      border-bottom: 2px solid #43b581;
      display: inline-block;
      padding-bottom: 2px;
    }
    .inventory ul, .abilities ul {
      list-style: none;
      padding: 0;
    }
    .inventory li, .abilities li {
      background: #23272a;
      margin-bottom: 6px;
      padding: 8px;
      border-radius: 6px;
      border-left: 4px solid #7289da;
    }
    /* Tooltip styles */
    .tooltip {
      position: absolute;
      background: #23272a;
      color: #fff;
      border: 1px solid #7289da;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 0.95em;
      z-index: 1000;
      pointer-events: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      max-width: 320px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <div class="section-title">Add to Character</div>
    <form id="addForm" style="margin-bottom:24px;">
      <label for="type">Type:</label>
      <select id="type" name="type">
        <option value="items">Item</option>
        <option value="equipment">Equipment</option>
        <option value="skills">Skill</option>
        <option value="spells">Spell</option>
      </select>
      <label for="suggestion">Name:</label>
      <input type="text" id="suggestion" name="suggestion" list="suggestions" autocomplete="off" required>
      <datalist id="suggestions"></datalist>
      <label for="count">Count:</label>
      <input type="number" id="count" name="count" min="1" value="1" required>
      <button type="submit">Add</button>
    </form>
    <div class="profile">
      <img src="avatar.png" alt="Character Avatar">
      <h2 id="char-name"></h2>
      <p id="char-class"></p>
      <div id="char-summary" style="margin-top:10px;color:#43b581;font-size:1em;"></div>
    </div>
      <!-- Avatar removed: file not found -->
    <div>
      <div class="stats">
        <div class="section-title">Stats</div>
        <table id="stats-table"></table>
      </div>
      <div class="inventory">
        <div class="section-title">Items & Gear</div>
        <ul id="items-list"></ul>
        <div class="section-title">Gear</div>
        <ul id="gears-list"></ul>
      </div>
      <div class="abilities">
        <div class="section-title">Skills</div>
        <ul id="skills-list"></ul>
        <div class="section-title">Spells</div>
        <ul id="spells-list"></ul>
      </div>
    </div>
  </div>
  <div id="sheet-data" style="margin:32px 0;"></div>
  <div id="tooltip" class="tooltip"></div>
  <script>
    // Suggestions infrastructure
    let sheetSuggestions = { items: [], equipment: [], skills: [], spells: [] };
    let dndData = null;
    async function loadSuggestions() {
      try {
        const res = await fetch('dnd_data.json');
        const data = await res.json();
        dndData = data;
        sheetSuggestions.items = (data.items || []).map(i => i.name);
        sheetSuggestions.equipment = (data.equipment || []).map(e => e.name);
        sheetSuggestions.skills = (data.skills || []).map(s => s.name);
        sheetSuggestions.spells = (data.spells || []).map(sp => sp.name);
        updateSuggestionsList('items');
      } catch (err) {
        console.error('Failed to load suggestions:', err);
      }
    }
    window.addEventListener('DOMContentLoaded', function() {
      loadSuggestions();
    });
    document.getElementById('type').addEventListener('change', function() {
      updateSuggestionsList(this.value);
    });
    function updateSuggestionsList(type) {
      const datalist = document.getElementById('suggestions');
      datalist.innerHTML = '';
      sheetSuggestions[type].forEach(s => {
        const option = document.createElement('option');
        option.value = s;
        datalist.appendChild(option);
      });
    }
    // Manual add logic
    document.getElementById('addForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const type = document.getElementById('type').value;
      const name = document.getElementById('suggestion').value.trim();
      const count = parseInt(document.getElementById('count').value);
      if (!name || !count) return;
      // Add to UI
      let ul;
      if (type === 'items') ul = document.getElementById('items-list');
      else if (type === 'equipment') ul = document.getElementById('gears-list');
      else if (type === 'skills') ul = document.getElementById('skills-list');
      else if (type === 'spells') ul = document.getElementById('spells-list');
      // Check if already exists
      let found = false;
      ul.querySelectorAll('li').forEach(li => {
        if (li.textContent.startsWith(name + ' x')) {
          let parts = li.textContent.split(' x');
          li.textContent = `${name} x${parseInt(parts[1]) + count}`;
          found = true;
        }
      });
      if (!found) {
        const li = document.createElement('li');
        li.textContent = `${name} x${count}`;
        ul.appendChild(li);
      }
      this.reset();
      updateSuggestionsList(document.getElementById('type').value);
    });
    async function loadData() {
      // Removed due to CORS issues and not being used
    }
    // setInterval(loadData, 5000);
    // loadData();
  </script>
  <script>
    // Supabase character sheet integration
    let currentUsername = null;
    let currentCharacter = null;
    // Expect username to be passed via localStorage from index.html
    window.addEventListener('DOMContentLoaded', async function() {
      // Try to get username from query string first
      function getQueryParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }
      let username = getQueryParam('username');
      if (!username) {
        username = localStorage.getItem('dnd_username');
      } else {
        localStorage.setItem('dnd_username', username);
      }
      if (username) {
        currentUsername = username;
        const character = await fetchCharacter(username);
        if (character) {
          currentCharacter = character;
          renderCharacterSheet(character);
        }
      } else {
        window.location.href = 'index.html';
      }
    });

    function renderCharacterSheet(character) {
  document.getElementById('char-name').textContent = character.name || character.username || '';
  document.getElementById('char-class').textContent = `Level ${character.level ?? ''} ${character.class ?? ''}`;
  // Summary
  let summary = '';
  if (character.race) summary += `<b>Race:</b> ${character.race} `;
  if (character.class) summary += `<b>Class:</b> ${character.class} `;
  if (character.background) summary += `<b>Background:</b> ${character.background}`;
  document.getElementById('char-summary').innerHTML = summary;

      // Bonus logic
      const raceInfo = {
        "Human": { bonus: { strength: 1, dexterity: 1, constitution: 1, intelligence: 1, wisdom: 1, charisma: 1 } },
        "Elf": { bonus: { dexterity: 2, intelligence: 1 } },
        "Dwarf": { bonus: { constitution: 2, strength: 2 } },
        "Halfling": { bonus: { dexterity: 2, charisma: 1 } },
        "Dragonborn": { bonus: { strength: 2, charisma: 1 } },
        "Gnome": { bonus: { intelligence: 2, dexterity: 1 } },
        "Half-Elf": { bonus: { charisma: 2 } },
        "Half-Orc": { bonus: { strength: 2, constitution: 1 } },
        "Tiefling": { bonus: { charisma: 2, intelligence: 1 } }
      };
      const classInfo = {
        "Fighter": { stat: "strength", skill: "Athletics" },
        "Rogue": { stat: "dexterity", skill: "Stealth" },
        "Wizard": { stat: "intelligence", skill: "Arcana" },
        "Cleric": { stat: "wisdom", skill: "Religion" },
        "Barbarian": { stat: "constitution", skill: "Athletics" },
        "Bard": { stat: "charisma", skill: "Performance" },
        "Druid": { stat: "wisdom", skill: "Nature" },
        "Monk": { stat: "dexterity", skill: "Acrobatics" },
        "Paladin": { stat: "strength", skill: "Persuasion" },
        "Ranger": { stat: "dexterity", skill: "Survival" },
        "Sorcerer": { stat: "charisma", skill: "Arcana" },
        "Warlock": { stat: "charisma", skill: "Intimidation" }
      };
      const backgroundInfo = {
        "Acolyte": ["Insight", "Religion"],
        "Charlatan": ["Deception", "Sleight of Hand"],
        "Criminal": ["Stealth", "Deception"],
        "Entertainer": ["Acrobatics", "Performance"],
        "Folk Hero": ["Animal Handling", "Survival"],
        "Guild Artisan": ["Insight", "Persuasion"],
        "Hermit": ["Medicine", "Religion"],
        "Noble": ["History", "Persuasion"],
        "Outlander": ["Athletics", "Survival"],
        "Sage": ["Arcana", "History"],
        "Sailor": ["Athletics", "Perception"],
        "Soldier": ["Athletics", "Intimidation"],
        "Urchin": ["Sleight of Hand", "Stealth"]
      };

      // Stats
      const statsTable = document.getElementById('stats-table');
      statsTable.innerHTML = '';
      const statKeys = ['strength','dexterity','constitution','intelligence','wisdom','charisma'];
      statKeys.forEach(key => {
        let base = character[key] ?? 0;
        let bonus = 0;
        let sources = [];
        // Race bonus
        if (character.race && raceInfo[character.race] && raceInfo[character.race].bonus && raceInfo[character.race].bonus[key]) {
          bonus += raceInfo[character.race].bonus[key];
          sources.push(`Race +${raceInfo[character.race].bonus[key]}`);
        }
        // Class bonus
        if (character.class && classInfo[character.class] && classInfo[character.class].stat === key) {
          bonus += 1;
          sources.push('Class +1');
        }
        // Show stat with bonus breakdown
        const row = document.createElement('tr');
        const th = document.createElement('th');
        th.textContent = key.charAt(0).toUpperCase() + key.slice(1);
        const td = document.createElement('td');
        td.textContent = base;
        if (bonus > 0) {
          td.textContent += ` (+${bonus} [${sources.join(', ')}])`;
        }
        row.appendChild(th);
        row.appendChild(td);
        statsTable.appendChild(row);
      });
      // Skills (only render once, with bonus breakdown)
      const skillsList = document.getElementById('skills-list');
      skillsList.innerHTML = '';
      (Array.isArray(character.skills) ? character.skills : []).forEach(skill => {
        let bonus = 0;
        let sources = [];
        // Class bonus
        if (character.class && classInfo[character.class] && classInfo[character.class].skill === skill.name) {
          bonus += 2;
          sources.push('Class +2');
        }
        // Background bonus
        if (character.background && backgroundInfo[character.background] && backgroundInfo[character.background].includes(skill.name)) {
          bonus += 2;
          sources.push('Background +2');
        }
        let display = `${skill.name} x${skill.count ?? 0}`;
        if (bonus > 0) {
          display += ` (+${bonus} [${sources.join(', ')}])`;
        }
        if ((skill.count ?? 0) > 0 || bonus > 0) {
          const li = document.createElement('li');
          li.textContent = display;
          li.setAttribute('data-type', 'skills');
          li.setAttribute('data-name', skill.name);
          skillsList.appendChild(li);
        }
      });
      // Items
      const itemsList = document.getElementById('items-list');
      itemsList.innerHTML = '';
      (Array.isArray(character.items) ? character.items : []).forEach(item => {
        if ((item.count ?? 0) > 0) {
          const li = document.createElement('li');
          li.textContent = `${item.name} x${item.count ?? 0}`;
          li.setAttribute('data-type', 'items');
          li.setAttribute('data-name', item.name);
          itemsList.appendChild(li);
        }
      });
      // Equipment
      const gearsList = document.getElementById('gears-list');
      gearsList.innerHTML = '';
      (Array.isArray(character.equipment) ? character.equipment : []).forEach(eq => {
        if ((eq.count ?? 0) > 0) {
          const li = document.createElement('li');
          li.textContent = `${eq.name} x${eq.count ?? 0}`;
          li.setAttribute('data-type', 'equipment');
          li.setAttribute('data-name', eq.name);
          gearsList.appendChild(li);
        }
      });
      // Spells
      const spellsList = document.getElementById('spells-list');
      spellsList.innerHTML = '';
      (Array.isArray(character.spells) ? character.spells : []).forEach(spell => {
        if ((spell.count ?? 0) > 0) {
          const li = document.createElement('li');
          li.textContent = `${spell.name} x${spell.count ?? 0}`;
          li.setAttribute('data-type', 'spells');
          li.setAttribute('data-name', spell.name);
          spellsList.appendChild(li);
        }
      });
      attachTooltipListeners();
    // Tooltip logic
    function getTooltipContent(type, name) {
      if (!dndData) return '';
      let entry = null;
      if (type === 'items') entry = (dndData.items || []).find(i => i.name === name);
      else if (type === 'equipment') entry = (dndData.equipment || []).find(e => e.name === name);
      else if (type === 'skills') entry = (dndData.skills || []).find(s => s.name === name);
      else if (type === 'spells') entry = (dndData.spells || []).find(sp => sp.name === name);
      if (!entry) return '';
      let html = `<b>${entry.name}</b><br>`;
      if (type === 'items' || type === 'equipment') {
        if (entry.type) html += `<i>Type:</i> ${entry.type}<br>`;
        if (entry.damage) html += `<i>Damage:</i> ${entry.damage}<br>`;
        if (entry.ac) html += `<i>AC:</i> ${entry.ac}<br>`;
        if (entry.ac_bonus) html += `<i>AC Bonus:</i> ${entry.ac_bonus}<br>`;
        if (entry.dex_bonus) html += `<i>Dex Bonus:</i> Yes<br>`;
        if (entry.strength_req) html += `<i>Strength Req:</i> ${entry.strength_req}<br>`;
        if (entry.stealth_disadvantage) html += `<i>Stealth Disadvantage:</i> Yes<br>`;
        if (entry.effect) html += `<i>Effect:</i> ${entry.effect}<br>`;
        if (entry.properties) html += `<i>Properties:</i> ${entry.properties.join(', ')}<br>`;
      }
      if (type === 'skills') {
        if (entry.ability) html += `<i>Ability:</i> ${entry.ability}<br>`;
      }
      if (type === 'spells') {
        if (entry.level) html += `<i>Level:</i> ${entry.level}<br>`;
        if (entry.school) html += `<i>School:</i> ${entry.school}<br>`;
        if (entry.description) html += `<i>Description:</i> ${entry.description}<br>`;
      }
      return html;
    }

    function showTooltip(e, type, name) {
      const tooltip = document.getElementById('tooltip');
      tooltip.innerHTML = getTooltipContent(type, name);
      tooltip.style.display = 'block';
      const rect = e.target.getBoundingClientRect();
      tooltip.style.left = `${rect.right + 10 + window.scrollX}px`;
      tooltip.style.top = `${rect.top + window.scrollY}px`;
    }

    function hideTooltip() {
      const tooltip = document.getElementById('tooltip');
      tooltip.style.display = 'none';
    }

    // Attach tooltip listeners after rendering character sheet
    function attachTooltipListeners() {
      ['items-list', 'gears-list', 'skills-list', 'spells-list'].forEach(listId => {
        const ul = document.getElementById(listId);
        if (!ul) return;
        ul.querySelectorAll('li').forEach(li => {
          li.addEventListener('mouseenter', function(e) {
            const type = li.getAttribute('data-type');
            const name = li.getAttribute('data-name');
            showTooltip(e, type, name);
          });
          li.addEventListener('mouseleave', hideTooltip);
        });
      });
    }
    }

    // Example: Add item and update DB
    async function addItemToCharacter(itemName, count) {
      if (!currentCharacter || !currentUsername) return;
      let items = currentCharacter.items || [];
      const idx = items.findIndex(i => i.name === itemName);
      if (idx > -1) items[idx].count += count;
      else items.push({ name: itemName, count });
      await updateCharacter(currentUsername, { items });
      currentCharacter.items = items;
      renderCharacterSheet(currentCharacter);
    }
  </script>
</body>
</html>