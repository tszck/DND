<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generate New Character</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="supabase.js"></script>
    <style>
      body { font-family: Arial, sans-serif; background: #23272a; color: #fff; }
      .form-box { background: #2c2f33; padding: 24px; border-radius: 10px; max-width: 400px; margin: 40px auto; }
      label { display: block; margin-top: 12px; }
      input, select { width: 100%; padding: 8px; margin-top: 4px; border-radius: 4px; border: none; }
      input::placeholder { color: #99aab5; font-style: italic; }
      button { margin-top: 16px; padding: 10px 20px; background: #7289da; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    </style>
</head>
<body>
  <div class="form-box">
    <h2>Generate New Character</h2>
    <div style="text-align:center;margin-bottom:12px;">
      <img id="avatar-preview" src="https://oitwwvjgkmzffsdsodzm.supabase.co/storage/v1/object/public/avatars/avatar.jpg" alt="Default Avatar" style="width:96px;height:96px;border-radius:50%;border:3px solid #7289da;object-fit:cover;display:block;margin:0 auto 8px;">
      <input type="file" id="avatar-upload" accept="image/jpeg" style="margin-bottom:8px;">
    </div>
    <form id="genForm">
  <label for="username">Username:</label>
  <input type="text" id="username" name="username" pattern="[a-z0-9]+" title="Username must contain only lowercase letters and numbers" placeholder="e.g. player123" required>
  <label for="name">Character Name:</label>
  <input type="text" id="name" name="name" placeholder="e.g. Aragorn the Brave" required>
  <label for="bio">Bio / Notes:</label>
  <textarea id="bio" name="bio" rows="3" placeholder="Describe your character's background, personality, or notes..." style="width:100%;margin-top:4px;border-radius:4px;padding:8px;"></textarea>
  <label for="race">Race:</label>
  <select id="race" name="race">
        <option>Human</option>
        <option>Elf</option>
        <option>Dwarf</option>
        <option>Halfling</option>
        <option>Dragonborn</option>
        <option>Gnome</option>
        <option>Half-Elf</option>
        <option>Half-Orc</option>
        <option>Tiefling</option>
      </select>
  <div id="race-desc" style="margin-bottom:8px;color:#43b581;font-size:0.95em;"></div>
  <div id="race-bonus" style="background:#23272a;border-left:4px solid #43b581;padding:8px 12px;margin-bottom:12px;border-radius:6px;display:none;font-size:0.98em;"></div>
      <label for="class">Class:</label>
      <select id="class" name="class">
        <option>Fighter</option>
        <option>Rogue</option>
        <option>Wizard</option>
        <option>Cleric</option>
        <option>Barbarian</option>
        <option>Bard</option>
        <option>Druid</option>
        <option>Monk</option>
        <option>Paladin</option>
        <option>Ranger</option>
        <option>Sorcerer</option>
        <option>Warlock</option>
      </select>
  <div id="class-desc" style="margin-bottom:8px;color:#43b581;font-size:0.95em;"></div>
  <div id="class-bonus" style="background:#23272a;border-left:4px solid #43b581;padding:8px 12px;margin-bottom:12px;border-radius:6px;display:none;font-size:0.98em;"></div>
      <label for="background">Background:</label>
      <select id="background" name="background">
        <option>Acolyte</option>
        <option>Charlatan</option>
        <option>Criminal</option>
        <option>Entertainer</option>
        <option>Folk Hero</option>
        <option>Guild Artisan</option>
        <option>Hermit</option>
        <option>Noble</option>
        <option>Outlander</option>
        <option>Sage</option>
        <option>Sailor</option>
        <option>Soldier</option>
        <option>Urchin</option>
      </select>
  <div id="background-desc" style="margin-bottom:8px;color:#43b581;font-size:0.95em;"></div>
  <div id="background-bonus" style="background:#23272a;border-left:4px solid #43b581;padding:8px 12px;margin-bottom:12px;border-radius:6px;display:none;font-size:0.98em;"></div>
      <button type="submit">Generate</button>
    </form>
    <button id="downloadBtn" style="display:none;">Print Character Sheet</button>
  </div>
  <script>
    // Avatar upload logic
    let avatarBlob = null;
    let avatarFileType = null;
    document.getElementById('avatar-upload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      if (file.type !== 'image/jpeg') {
        alert('Only JPEG images (.jpg) are allowed.');
        return;
      }
      if (file.size > 200*1024) {
        alert('Image must be under 200KB.');
        return;
      }
      // Resize image to max 256x256px
      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement('canvas');
        const maxDim = 256;
        let w = img.width, h = img.height;
        if (w > maxDim || h > maxDim) {
          if (w > h) {
            h = Math.round(h * (maxDim / w));
            w = maxDim;
          } else {
            w = Math.round(w * (maxDim / h));
            h = maxDim;
          }
        }
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);
        canvas.toBlob(function(blob) {
          avatarBlob = blob;
          avatarFileType = 'image/jpeg';
          // Show preview and clear any error handlers
          const preview = document.getElementById('avatar-preview');
          preview.onerror = null;
          preview.src = canvas.toDataURL('image/jpeg', 0.92);
        }, 'image/jpeg', 0.92);
      };
      const reader = new FileReader();
      reader.onload = function(ev) { img.src = ev.target.result; };
      reader.readAsDataURL(file);
    });
    let generatedBlob = null;
    function randomStat() { return Math.floor(Math.random() * 10) + 8; }

    // Descriptions and bonuses for each option
    const raceInfo = {
      "Human": { desc: "Versatile and ambitious, humans have built great civilizations and adapt quickly to new challenges.", bonus: { strength: 1, dexterity: 1, constitution: 1 } },
      "Elf": { desc: "Graceful and wise, elves are known for their long lifespans and deep connection to nature and magic.", bonus: { dexterity: 2, intelligence: 1 } },
      "Dwarf": { desc: "Stout and hardy, dwarves are master craftsmen and fierce warriors from ancient mountain halls.", bonus: { constitution: 2, strength: 1 } },
      "Halfling": { desc: "Cheerful and nimble, halflings value comfort, community, and cleverness above all.", bonus: { dexterity: 2, charisma: 1 } },
      "Dragonborn": { desc: "Proud and honorable, dragonborn possess draconic ancestry and a strong sense of destiny.", bonus: { strength: 2, charisma: 1 } },
      "Gnome": { desc: "Inventive and curious, gnomes are renowned for their wit, creativity, and magical talents.", bonus: { intelligence: 2, constitution: 1 } },
      "Half-Elf": { desc: "Diplomatic and adaptable, half-elves blend the best traits of elves and humans.", bonus: { charisma: 2, dexterity: 1 } },
      "Half-Orc": { desc: "Tough and determined, half-orcs are shaped by hardship and excel in strength and endurance.", bonus: { strength: 2, constitution: 1 } },
      "Tiefling": { desc: "Mysterious and charismatic, tieflings bear the mark of infernal heritage and possess innate magic.", bonus: { charisma: 2, intelligence: 1 } }
    };
    const classInfo = {
      "Fighter": { desc: "Masters of martial combat, fighters excel in battle and adapt to any fighting style.", bonus: { strength: 2 } },
      "Rogue": { desc: "Stealthy and cunning, rogues thrive on agility, trickery, and precision strikes.", bonus: { dexterity: 2 } },
      "Wizard": { desc: "Scholars of the arcane, wizards wield powerful spells and unravel magical mysteries.", bonus: { intelligence: 2 } },
      "Cleric": { desc: "Divine agents, clerics channel the power of their gods to heal, protect, and smite foes.", bonus: { wisdom: 2 } },
      "Barbarian": { desc: "Fierce warriors, barbarians tap into primal rage for unmatched strength and resilience.", bonus: { strength: 1, constitution: 1 } },
      "Bard": { desc: "Charismatic performers, bards inspire allies and manipulate magic through music and lore.", bonus: { charisma: 2 } },
      "Druid": { desc: "Guardians of nature, druids command the elements and transform into beasts.", bonus: { wisdom: 1, constitution: 1 } },
      "Monk": { desc: "Disciplined martial artists, monks harness inner energy for speed and precision.", bonus: { dexterity: 1, wisdom: 1 } },
      "Paladin": { desc: "Holy knights, paladins uphold justice and wield divine power against evil.", bonus: { strength: 1, charisma: 1 } },
      "Ranger": { desc: "Skilled hunters and trackers, rangers thrive in the wild and master ranged combat.", bonus: { dexterity: 1, wisdom: 1 } },
      "Sorcerer": { desc: "Innate spellcasters, sorcerers unleash raw magical power from within.", bonus: { charisma: 1, constitution: 1 } },
      "Warlock": { desc: "Pact-bound wielders of eldritch magic, warlocks draw power from mysterious patrons.", bonus: { charisma: 1, intelligence: 1 } }
    };
    const backgroundInfo = {
      "Acolyte": { desc: "Raised in temples, acolytes are devoted to faith and serve as spiritual guides.", skills: ["Insight", "Religion"], bonus: { wisdom: 1 } },
      "Charlatan": { desc: "Quick-witted tricksters, charlatans thrive on deception and clever schemes.", skills: ["Deception", "Sleight of Hand"], bonus: { charisma: 1 } },
      "Criminal": { desc: "Living outside the law, criminals are skilled in stealth and underworld dealings.", skills: ["Deception", "Stealth"], bonus: { dexterity: 1 } },
      "Entertainer": { desc: "Performers at heart, entertainers captivate audiences with talent and flair.", skills: ["Acrobatics", "Performance"], bonus: { charisma: 1 } },
      "Folk Hero": { desc: "Champions of the common folk, folk heroes rise from humble beginnings.", skills: ["Animal Handling", "Survival"], bonus: { constitution: 1 } },
      "Guild Artisan": { desc: "Skilled craftsmen, guild artisans create and trade goods in bustling markets.", skills: ["Insight", "Persuasion"], bonus: { intelligence: 1 } },
      "Hermit": { desc: "Hermits seek solitude and wisdom, often living far from civilization.", skills: ["Medicine", "Religion"], bonus: { wisdom: 1 } },
      "Noble": { desc: "Born to privilege, nobles wield influence and uphold family traditions.", skills: ["History", "Persuasion"], bonus: { charisma: 1 } },
      "Outlander": { desc: "Wanderers of the wild, outlanders survive in untamed lands.", skills: ["Athletics", "Survival"], bonus: { constitution: 1 } },
      "Sage": { desc: "Seekers of knowledge, sages dedicate their lives to study and research.", skills: ["Arcana", "History"], bonus: { intelligence: 1 } },
      "Sailor": { desc: "Adventurers of the sea, sailors are at home on ships and coastal towns.", skills: ["Athletics", "Perception"], bonus: { strength: 1 } },
      "Soldier": { desc: "Disciplined and battle-hardened, soldiers serve in organized armies.", skills: ["Athletics", "Intimidation"], bonus: { strength: 1 } },
      "Urchin": { desc: "Streetwise survivors, urchins navigate city alleys and hidden paths.", skills: ["Sleight of Hand", "Stealth"], bonus: { dexterity: 1 } }
    };
    // Show descriptions on change
    function updateDesc(selectId, descId, infoObj) {
      const select = document.getElementById(selectId);
      const descDiv = document.getElementById(descId);
      function setDesc() {
        const val = select.value;
        if (typeof infoObj[val] === 'string') descDiv.textContent = infoObj[val];
        else if (infoObj[val] && infoObj[val].desc) descDiv.textContent = infoObj[val].desc;
        else descDiv.textContent = '';
      }
      select.addEventListener('change', setDesc);
      setDesc();
    }
    updateDesc('race', 'race-desc', raceInfo);
    updateDesc('class', 'class-desc', classInfo);
    updateDesc('background', 'background-desc', backgroundInfo);

    // Username validation and formatting
    document.getElementById('username').addEventListener('input', function(e) {
      // Convert to lowercase and remove invalid characters
      let value = e.target.value.toLowerCase().replace(/[^a-z0-9]/g, '');
      e.target.value = value;
      
      // Update avatar preview to show potential avatar for this username
      if (value && !avatarBlob) {
        const avatarPreview = document.getElementById('avatar-preview');
        const potentialAvatarUrl = `https://oitwwvjgkmzffsdsodzm.supabase.co/storage/v1/object/public/avatars/avatar_${value}.jpg`;
        // Try to load the user's existing avatar, fallback to default if not found
        avatarPreview.onerror = function() {
          this.onerror = null;
          this.src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iOTYiIGhlaWdodD0iOTYiIHZpZXdCb3g9IjAgMCA5NiA5NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDgiIGN5PSI0OCIgcj0iNDgiIGZpbGw9IiM3Mjg5ZGEiLz4KPHN2ZyB4PSIyNCIgeT0iMjAiIHdpZHRoPSI0OCIgaGVpZ2h0PSI1NiI+CjxjaXJjbGUgY3g9IjI0IiBjeT0iMjAiIHI9IjEyIiBmaWxsPSIjZmZmIi8+CjxwYXRoIGQ9Im0gMTIgNDAgYyAwIC04IDggLTE2IDE2IC0xNiBzIDE2IDggMTYgMTYgdiA4IGMgMCA0IC00IDggLTggOCBoIC0xNiBjIC00IDAgLTggLTQgLTggLTggdiAtOCIgZmlsbD0iI2ZmZiIvPgo8L3N2Zz4KPC9zdmc+";
        };
        avatarPreview.src = potentialAvatarUrl;
      } else if (!value && !avatarBlob) {
        // Reset to default avatar when username is empty
        const avatarPreview = document.getElementById('avatar-preview');
        avatarPreview.src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iOTYiIGhlaWdodD0iOTYiIHZpZXdCb3g9IjAgMCA5NiA5NiIgZmlsbD0ibm9uZSIgeG1zbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDgiIGN5PSI0OCIgcj0iNDgiIGZpbGw9IiM3Mjg5ZGEiLz4KPHN2ZyB4PSIyNCIgeT0iMjAiIHdpZHRoPSI0OCIgaGVpZ2h0PSI1NiI+CjxjaXJjbGUgY3g9IjI0IiBjeT0iMjAiIHI9IjEyIiBmaWxsPSIjZmZmIi8+CjxwYXRoIGQ9Im0gMTIgNDAgYyAwIC04IDggLTE2IDE2IC0xNiBzIDE2IDggMTYgMTYgdiA4IGMgMCA0IC00IDggLTggOCBoIC0xNiBjIC00IDAgLTggLTQgLTggLTggdiAtOCIgZmlsbD0iI2ZmZiIvPgo8L3N2Zz4KPC9zdmc+";
      }
    });

    // Show race bonuses below menu
    function showRaceBonus() {
      const select = document.getElementById('race');
      const bonusDiv = document.getElementById('race-bonus');
      const val = select.value;
      if (raceInfo[val] && raceInfo[val].bonus) {
        const bonuses = Object.entries(raceInfo[val].bonus).map(([stat, amt]) => `+${amt} <span style='color:#43b581'>${stat.charAt(0).toUpperCase() + stat.slice(1)}</span>`);
        bonusDiv.style.display = 'block';
        bonusDiv.innerHTML = `<b>Bonuses:</b> ${bonuses.join(', ')}`;
      } else {
        bonusDiv.style.display = 'none';
        bonusDiv.innerHTML = '';
      }
    }
    document.getElementById('race').addEventListener('change', showRaceBonus);
    showRaceBonus();

    // Show class bonuses below menu
    function showClassBonus() {
      const select = document.getElementById('class');
      const bonusDiv = document.getElementById('class-bonus');
      const val = select.value;
      if (classInfo[val] && classInfo[val].bonus) {
        const bonuses = Object.entries(classInfo[val].bonus).map(([stat, amt]) => `+${amt} <span style='color:#43b581'>${stat.charAt(0).toUpperCase() + stat.slice(1)}</span>`);
        bonusDiv.style.display = 'block';
        bonusDiv.innerHTML = `<b>Bonuses:</b> ${bonuses.join(', ')}`;
      } else {
        bonusDiv.style.display = 'none';
        bonusDiv.innerHTML = '';
      }
    }
    document.getElementById('class').addEventListener('change', showClassBonus);
    showClassBonus();
    // Show background bonuses below menu
    function showBackgroundBonus() {
      const select = document.getElementById('background');
      const bonusDiv = document.getElementById('background-bonus');
      const val = select.value;
      if (backgroundInfo[val]) {
        let bonusText = '';
        if (backgroundInfo[val].bonus) {
          const statBonuses = Object.entries(backgroundInfo[val].bonus).map(([stat, amt]) => `+${amt} <span style='color:#43b581'>${stat.charAt(0).toUpperCase() + stat.slice(1)}</span>`);
          bonusText += `<b>Stat Bonus:</b> ${statBonuses.join(', ')}<br>`;
        }
        if (Array.isArray(backgroundInfo[val].skills)) {
          bonusText += `<b>Skill Bonus:</b> +2 to <span style='color:#43b581'>${backgroundInfo[val].skills.join('</span>, <span style=\'color:#43b581\'>')}</span>`;
        }
        if (bonusText) {
          bonusDiv.style.display = 'block';
          bonusDiv.innerHTML = bonusText;
        } else {
          bonusDiv.style.display = 'none';
          bonusDiv.innerHTML = '';
        }
      } else {
        bonusDiv.style.display = 'none';
        bonusDiv.innerHTML = '';
      }
    }
    document.getElementById('background').addEventListener('change', showBackgroundBonus);
    showBackgroundBonus();

    document.getElementById('genForm').addEventListener('submit', async function(e) {
      e.preventDefault();
  const username = document.getElementById('username').value.trim();
  const name = document.getElementById('name').value.trim();
  const bio = document.getElementById('bio').value.trim();
  const race = document.getElementById('race').value;
  const charClass = document.getElementById('class').value;
  const background = document.getElementById('background').value;
  const level = 1; // Default level

      // Load dnd_data.json for full item/equipment/skill/spell lists
      const res = await fetch('dnd_data.json');
      const dndData = await res.json();

      // Helper to initialize all entries with count 0
      function initEntries(list) {
        return (list || []).map(e => ({ name: e.name, count: 0 }));
      }

      // Stat base
      let stats = {
        strength: randomStat(),
        dexterity: randomStat(),
        constitution: randomStat(),
        intelligence: randomStat(),
        wisdom: randomStat(),
        charisma: randomStat()
      };
      // Apply race bonuses
      if (raceInfo[race] && raceInfo[race].bonus) {
        Object.entries(raceInfo[race].bonus).forEach(([stat, val]) => {
          stats[stat] += val;
        });
      }
      // Apply class bonuses
      if (classInfo[charClass] && classInfo[charClass].bonus) {
        Object.entries(classInfo[charClass].bonus).forEach(([stat, val]) => {
          stats[stat] += val;
        });
      }
      // Apply background bonuses
      if (backgroundInfo[background] && backgroundInfo[background].bonus) {
        Object.entries(backgroundInfo[background].bonus).forEach(([stat, val]) => {
          stats[stat] += val;
        });
      }
      // Skill bonuses
      function addSkillBonus(skills, skillName, amt) {
        const idx = skills.findIndex(s => s.name === skillName);
        if (idx > -1) skills[idx].count += amt;
      }
      let skills = initEntries(dndData.skills);
      // Class skill bonuses
      if (classInfo[charClass]) {
        const match = classInfo[charClass].desc.match(/\+2 ([A-Za-z ]+)/);
        if (match) addSkillBonus(skills, match[1], 2);
      }
      // Background skill proficiencies
      if (backgroundInfo[background] && Array.isArray(backgroundInfo[background].skills)) {
        backgroundInfo[background].skills.forEach(skillName => {
          if (skillName) addSkillBonus(skills, skillName, 2);
        });
      }

      let avatarUrl = '';
      if (avatarBlob && avatarFileType) {
        // Upload avatar to Supabase Storage - always use .jpg extension
        const fileName = `avatar_${username}.jpg`;
        const { data: uploadData, error: uploadError } = await supabaseClient.storage.from('avatars').upload(fileName, avatarBlob, {
          upsert: true,
          contentType: 'image/jpeg'
        });
        if (uploadError) {
          alert('Avatar upload failed: ' + uploadError.message);
        } else {
          // Use canonical public URL like in character sheet
          avatarUrl = `https://oitwwvjgkmzffsdsodzm.supabase.co/storage/v1/object/public/avatars/avatar_${username}.jpg`;
        }
      }
      const character = {
        username: username,
        name: name,
        race: race,
        class: charClass,
        background: background,
        level: level,
        xp: 0,
        strength: stats.strength ?? 8,
        dexterity: stats.dexterity ?? 8,
        constitution: stats.constitution ?? 8,
        intelligence: stats.intelligence ?? 8,
        wisdom: stats.wisdom ?? 8,
        charisma: stats.charisma ?? 8,
  items: Array.isArray(dndData.items) ? initEntries(dndData.items) : [],
        equipment: Array.isArray(dndData.equipment) ? initEntries(dndData.equipment) : [],
        skills: Array.isArray(skills) ? skills : [],
        spells: Array.isArray(dndData.spells) ? initEntries(dndData.spells) : [],
        bio: bio,
        avatar_url: avatarUrl,
        gold: 100,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      };
      // Note: gold is stored as top-level numeric field `gold` (100 G starting)
      // Save to Supabase. If the DB rejects the `gold` column because the schema wasn't migrated,
      // retry the insert without `gold` so client-side flows continue to work.
      let insertResp = await supabaseClient.from('characters').insert([character]);
      if (insertResp.error) {
        const msg = (insertResp.error.message || '').toLowerCase();
        if (msg.includes('could not find') && msg.includes('gold')) {
          console.warn('Insert failed due to missing gold column; retrying without gold.');
          const { gold, ...characterNoGold } = character;
          insertResp = await supabaseClient.from('characters').insert([characterNoGold]);
        }
      }
      if (insertResp.error) {
        alert('Error saving character: ' + insertResp.error.message);
      } else {
        alert('Character saved to database!');
      }
      generatedBlob = character; // Store character data instead of blob
      document.getElementById('downloadBtn').style.display = 'inline-block';
    });
    document.getElementById('downloadBtn').addEventListener('click', function() {
      if (generatedBlob) {
        openPrintableCharacterSheet(generatedBlob);
      }
    });

    function openPrintableCharacterSheet(character) {
      const printWindow = window.open('', '_blank', 'width=800,height=1000,scrollbars=yes');
      
      // Calculate total stats with bonuses
      const raceInfo = {
        "Human": { bonus: { strength: 1, dexterity: 1, constitution: 1 } },
        "Elf": { bonus: { dexterity: 2, intelligence: 1 } },
        "Dwarf": { bonus: { constitution: 2, strength: 1 } },
        "Halfling": { bonus: { dexterity: 2, charisma: 1 } },
        "Dragonborn": { bonus: { strength: 2, charisma: 1 } },
        "Gnome": { bonus: { intelligence: 2, constitution: 1 } },
        "Half-Elf": { bonus: { charisma: 2, dexterity: 1 } },
        "Half-Orc": { bonus: { strength: 2, constitution: 1 } },
        "Tiefling": { bonus: { charisma: 2, intelligence: 1 } }
      };
      const classInfo = {
        "Fighter": { bonus: { strength: 2 } },
        "Rogue": { bonus: { dexterity: 2 } },
        "Wizard": { bonus: { intelligence: 2 } },
        "Cleric": { bonus: { wisdom: 2 } },
        "Barbarian": { bonus: { strength: 1, constitution: 1 } },
        "Bard": { bonus: { charisma: 2 } },
        "Druid": { bonus: { wisdom: 1, constitution: 1 } },
        "Monk": { bonus: { dexterity: 1, wisdom: 1 } },
        "Paladin": { bonus: { strength: 1, charisma: 1 } },
        "Ranger": { bonus: { dexterity: 1, wisdom: 1 } },
        "Sorcerer": { bonus: { charisma: 1, constitution: 1 } },
        "Warlock": { bonus: { charisma: 1, intelligence: 1 } }
      };
      const backgroundInfo = {
        "Acolyte": { bonus: { wisdom: 1 } },
        "Charlatan": { bonus: { charisma: 1 } },
        "Criminal": { bonus: { dexterity: 1 } },
        "Entertainer": { bonus: { charisma: 1 } },
        "Folk Hero": { bonus: { constitution: 1 } },
        "Guild Artisan": { bonus: { intelligence: 1 } },
        "Hermit": { bonus: { wisdom: 1 } },
        "Noble": { bonus: { charisma: 1 } },
        "Outlander": { bonus: { constitution: 1 } },
        "Sage": { bonus: { intelligence: 1 } },
        "Sailor": { bonus: { strength: 1 } },
        "Soldier": { bonus: { strength: 1 } },
        "Urchin": { bonus: { dexterity: 1 } }
      };

      function getTotalStat(character, stat) {
        let total = character[stat] || 0;
        if (raceInfo[character.race] && raceInfo[character.race].bonus && raceInfo[character.race].bonus[stat]) {
          total += raceInfo[character.race].bonus[stat];
        }
        if (classInfo[character.class] && classInfo[character.class].bonus && classInfo[character.class].bonus[stat]) {
          total += classInfo[character.class].bonus[stat];
        }
        if (backgroundInfo[character.background] && backgroundInfo[character.background].bonus && backgroundInfo[character.background].bonus[stat]) {
          total += backgroundInfo[character.background].bonus[stat];
        }
        return total;
      }

      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>${character.name || character.username} - Character Sheet</title>
          <style>
            @media print {
              body { margin: 0; }
              .no-print { display: none; }
            }
            body { 
              font-family: 'Times New Roman', serif; 
              margin: 20px; 
              background: white; 
              color: black; 
              line-height: 1.4;
            }
            .header { 
              text-align: center; 
              border-bottom: 3px solid #000; 
              padding-bottom: 10px; 
              margin-bottom: 20px; 
            }
            .character-name { 
              font-size: 28px; 
              font-weight: bold; 
              margin: 0; 
            }
            .character-details { 
              font-size: 16px; 
              margin: 5px 0; 
            }
            .section { 
              margin-bottom: 20px; 
              border: 2px solid #000; 
              padding: 10px; 
            }
            .section-title { 
              font-size: 18px; 
              font-weight: bold; 
              border-bottom: 1px solid #000; 
              margin-bottom: 10px; 
              padding-bottom: 5px; 
            }
            .stats-grid { 
              display: grid; 
              grid-template-columns: repeat(3, 1fr); 
              gap: 10px; 
            }
            .stat-box { 
              border: 1px solid #000; 
              padding: 8px; 
              text-align: center; 
            }
            .stat-name { 
              font-weight: bold; 
              font-size: 12px; 
            }
            .stat-value { 
              font-size: 20px; 
              font-weight: bold; 
            }
            .equipment-list { 
              columns: 2; 
              column-gap: 20px; 
            }
            .equipment-item { 
              break-inside: avoid; 
              margin-bottom: 5px; 
            }
            .no-print { 
              position: fixed; 
              top: 10px; 
              right: 10px; 
            }
            button { 
              padding: 10px 20px; 
              font-size: 16px; 
              cursor: pointer; 
            }
          </style>
        </head>
        <body>
          <button class="no-print" onclick="window.print()">Print Character Sheet</button>
          
          <div class="header">
            <h1 class="character-name">${character.name || character.username}</h1>
            <div class="character-details">
              Level ${character.level} ${character.race} ${character.class}
            </div>
            <div class="character-details">
              Background: ${character.background} | Username: ${character.username}
            </div>
          </div>

          <div class="section">
            <div class="section-title">Ability Scores</div>
            <div class="stats-grid">
              <div class="stat-box">
                <div class="stat-name">STRENGTH</div>
                <div class="stat-value">${getTotalStat(character, 'strength')}</div>
              </div>
              <div class="stat-box">
                <div class="stat-name">DEXTERITY</div>
                <div class="stat-value">${getTotalStat(character, 'dexterity')}</div>
              </div>
              <div class="stat-box">
                <div class="stat-name">CONSTITUTION</div>
                <div class="stat-value">${getTotalStat(character, 'constitution')}</div>
              </div>
              <div class="stat-box">
                <div class="stat-name">INTELLIGENCE</div>
                <div class="stat-value">${getTotalStat(character, 'intelligence')}</div>
              </div>
              <div class="stat-box">
                <div class="stat-name">WISDOM</div>
                <div class="stat-value">${getTotalStat(character, 'wisdom')}</div>
              </div>
              <div class="stat-box">
                <div class="stat-name">CHARISMA</div>
                <div class="stat-value">${getTotalStat(character, 'charisma')}</div>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="section-title">Character Progress</div>
            <p><strong>Level:</strong> ${character.level}</p>
            <p><strong>Experience Points:</strong> ${character.xp || 0}</p>
            <p><strong>XP to Next Level:</strong> ${(100 * character.level) - (character.xp || 0)}</p>
          </div>

          <div class="section">
            <div class="section-title">Equipment & Items</div>
            <div class="equipment-list">
              ${character.equipment ? character.equipment.filter(eq => eq.count > 0).map(eq => 
                `<div class="equipment-item">${eq.name} (${eq.count})</div>`
              ).join('') : '<div>No equipment</div>'}
              ${character.items ? character.items.filter(item => item.count > 0).map(item => 
                `<div class="equipment-item">${item.name} (${item.count})</div>`
              ).join('') : ''}
            </div>
          </div>

          <div class="section">
            <div class="section-title">Skills & Spells</div>
            <div class="equipment-list">
              ${character.skills ? character.skills.filter(skill => skill.count > 0).map(skill => 
                `<div class="equipment-item">${skill.name} (Level ${skill.count})</div>`
              ).join('') : '<div>No skills</div>'}
              ${character.spells ? character.spells.filter(spell => spell.count > 0).map(spell => 
                `<div class="equipment-item">${spell.name}</div>`
              ).join('') : ''}
            </div>
          </div>

          <div class="section">
            <div class="section-title">Notes</div>
            <div style="height: 150px; border: 1px solid #ccc; padding: 10px;">
              ${character.bio || 'The tale of this adventurer is yet to be written...'}
            </div>
          </div>
        </body>
        </html>
      `);
      
      printWindow.document.close();
    }
    function getTooltipContent(type, name) {
  if (!dndData) return '';
  let entry = null;
  if (type === 'items') entry = (dndData.items || []).find(i => i.name === name);
  else if (type === 'equipment') entry = (dndData.equipment || []).find(e => e.name === name);
  else if (type === 'skills') entry = (dndData.skills || []).find(s => s.name === name);
  else if (type === 'spells') entry = (dndData.spells || []).find(sp => sp.name === name);
  if (!entry) return '';
  let html = `<b>${entry.name}</b><br>`;
  if (type === 'items' || type === 'equipment') {
    if (entry.type) html += `<i>Type:</i> ${entry.type}<br>`;
    if (entry.damage) html += `<i>Damage:</i> ${entry.damage}<br>`;
    if (entry.ac) html += `<i>AC:</i> ${entry.ac}<br>`;
    if (entry.ac_bonus) html += `<i>AC Bonus:</i> ${entry.ac_bonus}<br>`;
    if (entry.dex_bonus) html += `<i>Dex Bonus:</i> Yes<br>`;
    if (entry.strength_req) html += `<i>Strength Req:</i> ${entry.strength_req}<br>`;
    if (entry.stealth_disadvantage) html += `<i>Stealth Disadvantage:</i> Yes<br>`;
    if (entry.effect) html += `<i>Effect:</i> ${entry.effect}<br>`;
    if (entry.properties) html += `<i>Properties:</i> ${entry.properties.join(', ')}<br>`;
  }
  if (type === 'skills') {
    if (entry.ability) html += `<i>Ability:</i> ${entry.ability}<br>`;
    if (Array.isArray(entry.effects)) {
      html += `<b>Buffs/Debuffs:</b><br>`;
      entry.effects.forEach(eff => {
        let color = eff.type === 'buff' ? '#43b581' : '#f04747';
        let effectText = eff.effect_type === 'advantage' ? 'Advantage (roll twice, take higher)' :
          eff.effect_type === 'disadvantage' ? 'Disadvantage (roll twice, take lower)' :
          (eff.effect_type === 'modifier' ? (eff.value > 0 ? `+${eff.value}` : `${eff.value}`) : '');
        html += `<span style='color:${color}'>${eff.source}: ${effectText}</span><br>`;
      });
    }
  }
  if (type === 'spells') {
    if (entry.level) html += `<i>Level:</i> ${entry.level}<br>`;
    if (entry.school) html += `<i>School:</i> ${entry.school}<br>`;
    if (entry.description) html += `<i>Description:</i> ${entry.description}<br>`;
    if (Array.isArray(entry.buffs_granted) && entry.buffs_granted.length) {
      html += `<b>Buffs Granted:</b> ${entry.buffs_granted.join(', ')}<br>`;
    }
    if (Array.isArray(entry.debuffs_granted) && entry.debuffs_granted.length) {
      html += `<b>Debuffs Granted:</b> ${entry.debuffs_granted.join(', ')}<br>`;
    }
    if (Array.isArray(entry.buffs_removed) && entry.buffs_removed.length) {
      html += `<b>Buffs Removed:</b> ${entry.buffs_removed.join(', ')}<br>`;
    }
    if (Array.isArray(entry.debuffs_removed) && entry.debuffs_removed.length) {
      html += `<b>Debuffs Removed:</b> ${entry.debuffs_removed.join(', ')}<br>`;
    }
    if (entry.hp_change) html += `<b>HP Change:</b> ${entry.hp_change}<br>`;
  }
  return html;
}
  </script>
</body>
</html>