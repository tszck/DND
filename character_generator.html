<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generate New Character</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="supabase.js"></script>
    <style>
      body { font-family: Arial, sans-serif; background: #23272a; color: #fff; }
      .form-box { background: #2c2f33; padding: 24px; border-radius: 10px; max-width: 400px; margin: 40px auto; }
      label { display: block; margin-top: 12px; }
      input, select { width: 100%; padding: 8px; margin-top: 4px; border-radius: 4px; border: none; }
      button { margin-top: 16px; padding: 10px 20px; background: #7289da; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    </style>
</head>
<body>
  <div class="form-box">
    <h2>Generate New Character</h2>
    <form id="genForm">
      <label for="name">Name:</label>
      <input type="text" id="name" name="name" required>
      <label for="race">Race:</label>
      <select id="race" name="race">
        <option>Human</option>
        <option>Elf</option>
        <option>Dwarf</option>
        <option>Halfling</option>
        <option>Dragonborn</option>
        <option>Gnome</option>
        <option>Half-Elf</option>
        <option>Half-Orc</option>
        <option>Tiefling</option>
      </select>
      <div id="race-desc" style="margin-bottom:8px;color:#43b581;font-size:0.95em;"></div>
      <label for="class">Class:</label>
      <select id="class" name="class">
        <option>Fighter</option>
        <option>Rogue</option>
        <option>Wizard</option>
        <option>Cleric</option>
        <option>Barbarian</option>
        <option>Bard</option>
        <option>Druid</option>
        <option>Monk</option>
        <option>Paladin</option>
        <option>Ranger</option>
        <option>Sorcerer</option>
        <option>Warlock</option>
      </select>
      <div id="class-desc" style="margin-bottom:8px;color:#43b581;font-size:0.95em;"></div>
      <label for="background">Background:</label>
      <select id="background" name="background">
        <option>Acolyte</option>
        <option>Charlatan</option>
        <option>Criminal</option>
        <option>Entertainer</option>
        <option>Folk Hero</option>
        <option>Guild Artisan</option>
        <option>Hermit</option>
        <option>Noble</option>
        <option>Outlander</option>
        <option>Sage</option>
        <option>Sailor</option>
        <option>Soldier</option>
        <option>Urchin</option>
      </select>
      <div id="background-desc" style="margin-bottom:8px;color:#43b581;font-size:0.95em;"></div>
      <label for="level">Level:</label>
      <input type="number" id="level" name="level" min="1" max="20" value="1" required>
      <button type="submit">Generate</button>
    </form>
    <button id="downloadBtn" style="display:none;">Download Character JSON</button>
  </div>
  <script>
    let generatedBlob = null;
    function randomStat() { return Math.floor(Math.random() * 10) + 8; }

    // Descriptions and bonuses for each option
    const raceInfo = {
      "Human": { desc: "+1 to all stats.", bonus: { strength: 1, dexterity: 1, constitution: 1, intelligence: 1, wisdom: 1, charisma: 1 } },
      "Elf": { desc: "+2 Dexterity, +1 Intelligence.", bonus: { dexterity: 2, intelligence: 1 } },
      "Dwarf": { desc: "+2 Constitution, +2 Strength.", bonus: { constitution: 2, strength: 2 } },
      "Halfling": { desc: "+2 Dexterity, +1 Charisma.", bonus: { dexterity: 2, charisma: 1 } },
      "Dragonborn": { desc: "+2 Strength, +1 Charisma.", bonus: { strength: 2, charisma: 1 } },
      "Gnome": { desc: "+2 Intelligence, +1 Dexterity.", bonus: { intelligence: 2, dexterity: 1 } },
      "Half-Elf": { desc: "+2 Charisma, +1 to two other stats.", bonus: { charisma: 2 } },
      "Half-Orc": { desc: "+2 Strength, +1 Constitution.", bonus: { strength: 2, constitution: 1 } },
      "Tiefling": { desc: "+2 Charisma, +1 Intelligence.", bonus: { charisma: 2, intelligence: 1 } }
    };
    const classInfo = {
      "Fighter": { desc: "+2 Athletics, +1 Strength." },
      "Rogue": { desc: "+2 Stealth, +1 Dexterity." },
      "Wizard": { desc: "+2 Arcana, +1 Intelligence." },
      "Cleric": { desc: "+2 Religion, +1 Wisdom." },
      "Barbarian": { desc: "+2 Athletics, +1 Constitution." },
      "Bard": { desc: "+2 Performance, +1 Charisma." },
      "Druid": { desc: "+2 Nature, +1 Wisdom." },
      "Monk": { desc: "+2 Acrobatics, +1 Dexterity." },
      "Paladin": { desc: "+2 Persuasion, +1 Strength." },
      "Ranger": { desc: "+2 Survival, +1 Dexterity." },
      "Sorcerer": { desc: "+2 Arcana, +1 Charisma." },
      "Warlock": { desc: "+2 Intimidation, +1 Charisma." }
    };
    const backgroundInfo = {
      "Acolyte": { desc: "Skill Proficiencies: Insight, Religion.", skills: ["Insight", "Religion"] },
      "Charlatan": { desc: "Skill Proficiencies: Deception, Sleight of Hand.", skills: ["Deception", "Sleight of Hand"] },
      "Criminal": { desc: "Skill Proficiencies: Deception, Stealth.", skills: ["Deception", "Stealth"] },
      "Entertainer": { desc: "Skill Proficiencies: Acrobatics, Performance.", skills: ["Acrobatics", "Performance"] },
      "Folk Hero": { desc: "Skill Proficiencies: Animal Handling, Survival.", skills: ["Animal Handling", "Survival"] },
      "Guild Artisan": { desc: "Skill Proficiencies: Insight, Persuasion.", skills: ["Insight", "Persuasion"] },
      "Hermit": { desc: "Skill Proficiencies: Medicine, Religion.", skills: ["Medicine", "Religion"] },
      "Noble": { desc: "Skill Proficiencies: History, Persuasion.", skills: ["History", "Persuasion"] },
      "Outlander": { desc: "Skill Proficiencies: Athletics, Survival.", skills: ["Athletics", "Survival"] },
      "Sage": { desc: "Skill Proficiencies: Arcana, History.", skills: ["Arcana", "History"] },
      "Sailor": { desc: "Skill Proficiencies: Athletics, Perception.", skills: ["Athletics", "Perception"] },
      "Soldier": { desc: "Skill Proficiencies: Athletics, Intimidation.", skills: ["Athletics", "Intimidation"] },
      "Urchin": { desc: "Skill Proficiencies: Sleight of Hand, Stealth.", skills: ["Sleight of Hand", "Stealth"] }
    };
    // Show descriptions on change
    function updateDesc(selectId, descId, infoObj) {
      const select = document.getElementById(selectId);
      const descDiv = document.getElementById(descId);
      function setDesc() {
        const val = select.value;
        if (typeof infoObj[val] === 'string') descDiv.textContent = infoObj[val];
        else if (infoObj[val] && infoObj[val].desc) descDiv.textContent = infoObj[val].desc;
        else descDiv.textContent = '';
      }
      select.addEventListener('change', setDesc);
      setDesc();
    }
    updateDesc('race', 'race-desc', raceInfo);
    updateDesc('class', 'class-desc', classInfo);

    document.getElementById('genForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const race = document.getElementById('race').value;
      const charClass = document.getElementById('class').value;
      const level = parseInt(document.getElementById('level').value);

      // Load dnd_data.json for full item/equipment/skill/spell lists
      const res = await fetch('dnd_data.json');
      const dndData = await res.json();

      // Helper to initialize all entries with count 0
      function initEntries(list) {
        return (list || []).map(e => ({ name: e.name, count: 0 }));
      }

      // Stat base
      let stats = {
        strength: randomStat(),
        dexterity: randomStat(),
        constitution: randomStat(),
        intelligence: randomStat(),
        wisdom: randomStat(),
        charisma: randomStat()
      };
      // Apply race bonuses
      if (raceInfo[race] && raceInfo[race].bonus) {
        Object.entries(raceInfo[race].bonus).forEach(([stat, val]) => {
          stats[stat] += val;
        });
      }
      // Apply class bonuses
      if (classInfo[charClass]) {
        if (classInfo[charClass].desc.includes('Strength')) stats.strength += 1;
        if (classInfo[charClass].desc.includes('Dexterity')) stats.dexterity += 1;
        if (classInfo[charClass].desc.includes('Constitution')) stats.constitution += 1;
        if (classInfo[charClass].desc.includes('Intelligence')) stats.intelligence += 1;
        if (classInfo[charClass].desc.includes('Wisdom')) stats.wisdom += 1;
        if (classInfo[charClass].desc.includes('Charisma')) stats.charisma += 1;
      }
      // Skill bonuses
      function addSkillBonus(skills, skillName, amt) {
        const idx = skills.findIndex(s => s.name === skillName);
        if (idx > -1) skills[idx].count += amt;
      }
      let skills = initEntries(dndData.skills);
      // Class skill bonuses
      if (classInfo[charClass]) {
        const match = classInfo[charClass].desc.match(/\+2 ([A-Za-z ]+)/);
        if (match) addSkillBonus(skills, match[1], 2);
      }
      // Background skill proficiencies
      if (backgroundInfo[background] && Array.isArray(backgroundInfo[background].skills)) {
        backgroundInfo[background].skills.forEach(skillName => {
          if (skillName) addSkillBonus(skills, skillName, 2);
        });
      }

      const character = {
        username: name.toLowerCase(),
        name: name,
        race: race,
        class: charClass,
        background: background,
        level: level,
        strength: stats.strength ?? 0,
        dexterity: stats.dexterity ?? 0,
        constitution: stats.constitution ?? 0,
        intelligence: stats.intelligence ?? 0,
        wisdom: stats.wisdom ?? 0,
        charisma: stats.charisma ?? 0,
        items: Array.isArray(dndData.items) ? initEntries(dndData.items) : [],
        equipment: Array.isArray(dndData.equipment) ? initEntries(dndData.equipment) : [],
        skills: Array.isArray(skills) ? skills : [],
        spells: Array.isArray(dndData.spells) ? initEntries(dndData.spells) : [],
        bio: ''
      };
      // Save to Supabase
      const { data, error } = await supabase.from('characters').insert([character]);
      if (error) {
        alert('Error saving character: ' + error.message);
      } else {
        alert('Character saved to database!');
      }
      generatedBlob = new Blob([JSON.stringify(character, null, 2)], {type: 'application/json'});
      document.getElementById('downloadBtn').style.display = 'inline-block';
    });
    document.getElementById('downloadBtn').addEventListener('click', function() {
      if (generatedBlob) {
        const name = document.getElementById('name').value.trim();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(generatedBlob);
        a.download = `${name}.json`;
        a.click();
      }
    });
  </script>
</body>
</html>