<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generate New Character</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="supabase.js"></script>
    <style>
      body { font-family: Arial, sans-serif; background: #23272a; color: #fff; }
      .form-box { background: #2c2f33; padding: 24px; border-radius: 10px; max-width: 400px; margin: 40px auto; }
      label { display: block; margin-top: 12px; }
      input, select { width: 100%; padding: 8px; margin-top: 4px; border-radius: 4px; border: none; }
      input::placeholder { color: #99aab5; font-style: italic; }
      button { margin-top: 16px; padding: 10px 20px; background: #7289da; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    </style>
</head>
<body>
  <div class="form-box">
    <h2>Generate New Character</h2>
    <form id="genForm">
      <label for="username">Username:</label>
      <input type="text" id="username" name="username" pattern="[a-z0-9]+" title="Username must contain only lowercase letters and numbers" placeholder="e.g. player123" required>
      <label for="name">Character Name:</label>
      <input type="text" id="name" name="name" placeholder="e.g. Aragorn the Brave" required>
      <label for="race">Race:</label>
      <select id="race" name="race">
        <option>Human</option>
        <option>Elf</option>
        <option>Dwarf</option>
        <option>Halfling</option>
        <option>Dragonborn</option>
        <option>Gnome</option>
        <option>Half-Elf</option>
        <option>Half-Orc</option>
        <option>Tiefling</option>
      </select>
  <div id="race-desc" style="margin-bottom:8px;color:#43b581;font-size:0.95em;"></div>
  <div id="race-bonus" style="background:#23272a;border-left:4px solid #43b581;padding:8px 12px;margin-bottom:12px;border-radius:6px;display:none;font-size:0.98em;"></div>
      <label for="class">Class:</label>
      <select id="class" name="class">
        <option>Fighter</option>
        <option>Rogue</option>
        <option>Wizard</option>
        <option>Cleric</option>
        <option>Barbarian</option>
        <option>Bard</option>
        <option>Druid</option>
        <option>Monk</option>
        <option>Paladin</option>
        <option>Ranger</option>
        <option>Sorcerer</option>
        <option>Warlock</option>
      </select>
  <div id="class-desc" style="margin-bottom:8px;color:#43b581;font-size:0.95em;"></div>
  <div id="class-bonus" style="background:#23272a;border-left:4px solid #43b581;padding:8px 12px;margin-bottom:12px;border-radius:6px;display:none;font-size:0.98em;"></div>
      <label for="background">Background:</label>
      <select id="background" name="background">
        <option>Acolyte</option>
        <option>Charlatan</option>
        <option>Criminal</option>
        <option>Entertainer</option>
        <option>Folk Hero</option>
        <option>Guild Artisan</option>
        <option>Hermit</option>
        <option>Noble</option>
        <option>Outlander</option>
        <option>Sage</option>
        <option>Sailor</option>
        <option>Soldier</option>
        <option>Urchin</option>
      </select>
  <div id="background-desc" style="margin-bottom:8px;color:#43b581;font-size:0.95em;"></div>
  <div id="background-bonus" style="background:#23272a;border-left:4px solid #43b581;padding:8px 12px;margin-bottom:12px;border-radius:6px;display:none;font-size:0.98em;"></div>
      <label for="level">Level:</label>
      <input type="number" id="level" name="level" min="1" max="20" value="1" placeholder="Character level (1-20)" required>
      <button type="submit">Generate</button>
    </form>
    <button id="downloadBtn" style="display:none;">Download Character JSON</button>
  </div>
  <script>
    let generatedBlob = null;
    function randomStat() { return Math.floor(Math.random() * 10) + 8; }

    // Descriptions and bonuses for each option
    const raceInfo = {
      "Human": { desc: "Versatile and ambitious, humans have built great civilizations and adapt quickly to new challenges.", bonus: { strength: 1, dexterity: 1, constitution: 1, intelligence: 1, wisdom: 1, charisma: 1 } },
      "Elf": { desc: "Graceful and wise, elves are known for their long lifespans and deep connection to nature and magic.", bonus: { dexterity: 2, intelligence: 1 } },
      "Dwarf": { desc: "Stout and hardy, dwarves are master craftsmen and fierce warriors from ancient mountain halls.", bonus: { constitution: 2, strength: 2 } },
      "Halfling": { desc: "Cheerful and nimble, halflings value comfort, community, and cleverness above all.", bonus: { dexterity: 2, charisma: 1 } },
      "Dragonborn": { desc: "Proud and honorable, dragonborn possess draconic ancestry and a strong sense of destiny.", bonus: { strength: 2, charisma: 1 } },
      "Gnome": { desc: "Inventive and curious, gnomes are renowned for their wit, creativity, and magical talents.", bonus: { intelligence: 2, dexterity: 1 } },
      "Half-Elf": { desc: "Diplomatic and adaptable, half-elves blend the best traits of elves and humans.", bonus: { charisma: 2 } },
      "Half-Orc": { desc: "Tough and determined, half-orcs are shaped by hardship and excel in strength and endurance.", bonus: { strength: 2, constitution: 1 } },
      "Tiefling": { desc: "Mysterious and charismatic, tieflings bear the mark of infernal heritage and possess innate magic.", bonus: { charisma: 2, intelligence: 1 } }
    };
    const classInfo = {
      "Fighter": { desc: "Masters of martial combat, fighters excel in battle and adapt to any fighting style." },
      "Rogue": { desc: "Stealthy and cunning, rogues thrive on agility, trickery, and precision strikes." },
      "Wizard": { desc: "Scholars of the arcane, wizards wield powerful spells and unravel magical mysteries." },
      "Cleric": { desc: "Divine agents, clerics channel the power of their gods to heal, protect, and smite foes." },
      "Barbarian": { desc: "Fierce warriors, barbarians tap into primal rage for unmatched strength and resilience." },
      "Bard": { desc: "Charismatic performers, bards inspire allies and manipulate magic through music and lore." },
      "Druid": { desc: "Guardians of nature, druids command the elements and transform into beasts." },
      "Monk": { desc: "Disciplined martial artists, monks harness inner energy for speed and precision." },
      "Paladin": { desc: "Holy knights, paladins uphold justice and wield divine power against evil." },
      "Ranger": { desc: "Skilled hunters and trackers, rangers thrive in the wild and master ranged combat." },
      "Sorcerer": { desc: "Innate spellcasters, sorcerers unleash raw magical power from within." },
      "Warlock": { desc: "Pact-bound wielders of eldritch magic, warlocks draw power from mysterious patrons." }
    };
    const backgroundInfo = {
      "Acolyte": { desc: "Raised in temples, acolytes are devoted to faith and serve as spiritual guides.", skills: ["Insight", "Religion"] },
      "Charlatan": { desc: "Quick-witted tricksters, charlatans thrive on deception and clever schemes.", skills: ["Deception", "Sleight of Hand"] },
      "Criminal": { desc: "Living outside the law, criminals are skilled in stealth and underworld dealings.", skills: ["Deception", "Stealth"] },
      "Entertainer": { desc: "Performers at heart, entertainers captivate audiences with talent and flair.", skills: ["Acrobatics", "Performance"] },
      "Folk Hero": { desc: "Champions of the common folk, folk heroes rise from humble beginnings.", skills: ["Animal Handling", "Survival"] },
      "Guild Artisan": { desc: "Skilled craftsmen, guild artisans create and trade goods in bustling markets.", skills: ["Insight", "Persuasion"] },
      "Hermit": { desc: "Hermits seek solitude and wisdom, often living far from civilization.", skills: ["Medicine", "Religion"] },
      "Noble": { desc: "Born to privilege, nobles wield influence and uphold family traditions.", skills: ["History", "Persuasion"] },
      "Outlander": { desc: "Wanderers of the wild, outlanders survive in untamed lands.", skills: ["Athletics", "Survival"] },
      "Sage": { desc: "Seekers of knowledge, sages dedicate their lives to study and research.", skills: ["Arcana", "History"] },
      "Sailor": { desc: "Adventurers of the sea, sailors are at home on ships and coastal towns.", skills: ["Athletics", "Perception"] },
      "Soldier": { desc: "Disciplined and battle-hardened, soldiers serve in organized armies.", skills: ["Athletics", "Intimidation"] },
      "Urchin": { desc: "Streetwise survivors, urchins navigate city alleys and hidden paths.", skills: ["Sleight of Hand", "Stealth"] }
    };
    // Show descriptions on change
    function updateDesc(selectId, descId, infoObj) {
      const select = document.getElementById(selectId);
      const descDiv = document.getElementById(descId);
      function setDesc() {
        const val = select.value;
        if (typeof infoObj[val] === 'string') descDiv.textContent = infoObj[val];
        else if (infoObj[val] && infoObj[val].desc) descDiv.textContent = infoObj[val].desc;
        else descDiv.textContent = '';
      }
      select.addEventListener('change', setDesc);
      setDesc();
    }
    updateDesc('race', 'race-desc', raceInfo);
    updateDesc('class', 'class-desc', classInfo);
    updateDesc('background', 'background-desc', backgroundInfo);

    // Username validation and formatting
    document.getElementById('username').addEventListener('input', function(e) {
      // Convert to lowercase and remove invalid characters
      let value = e.target.value.toLowerCase().replace(/[^a-z0-9]/g, '');
      e.target.value = value;
    });

    // Show race bonuses below menu
    function showRaceBonus() {
      const select = document.getElementById('race');
      const bonusDiv = document.getElementById('race-bonus');
      const val = select.value;
      if (raceInfo[val] && raceInfo[val].bonus) {
        const bonuses = Object.entries(raceInfo[val].bonus).map(([stat, amt]) => `+${amt} <span style='color:#43b581'>${stat.charAt(0).toUpperCase() + stat.slice(1)}</span>`);
        bonusDiv.style.display = 'block';
        bonusDiv.innerHTML = `<b>Bonuses:</b> ${bonuses.join(', ')}`;
      } else {
        bonusDiv.style.display = 'none';
        bonusDiv.innerHTML = '';
      }
    }
    document.getElementById('race').addEventListener('change', showRaceBonus);
    showRaceBonus();

    // Show class bonuses below menu
    function showClassBonus() {
      const select = document.getElementById('class');
      const bonusDiv = document.getElementById('class-bonus');
      const val = select.value;
      if (classInfo[val] && classInfo[val].desc) {
        bonusDiv.style.display = 'block';
        bonusDiv.innerHTML = `<b>Bonuses:</b> <span style='color:#43b581'>${classInfo[val].desc.replace(/\+([0-9]) ([A-Za-z ]+)/g, '+$1 <span style=\'color:#43b581\'>$2</span>').replace(/\./g, '')}</span>`;
      } else {
        bonusDiv.style.display = 'none';
        bonusDiv.innerHTML = '';
      }
    }
    document.getElementById('class').addEventListener('change', showClassBonus);
    showClassBonus();
    // Show background bonuses below menu
    function showBackgroundBonus() {
      const select = document.getElementById('background');
      const bonusDiv = document.getElementById('background-bonus');
      const val = select.value;
      if (backgroundInfo[val] && Array.isArray(backgroundInfo[val].skills)) {
        bonusDiv.style.display = 'block';
        bonusDiv.innerHTML = `<b>Bonuses:</b> +2 to <span style='color:#43b581'>${backgroundInfo[val].skills.join('</span>, <span style=\'color:#43b581\'>')}</span>`;
      } else {
        bonusDiv.style.display = 'none';
        bonusDiv.innerHTML = '';
      }
    }
    document.getElementById('background').addEventListener('change', showBackgroundBonus);
    showBackgroundBonus();

    document.getElementById('genForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const username = document.getElementById('username').value.trim();
      const name = document.getElementById('name').value.trim();
      const race = document.getElementById('race').value;
      const charClass = document.getElementById('class').value;
      const background = document.getElementById('background').value;
      const level = parseInt(document.getElementById('level').value);

      // Load dnd_data.json for full item/equipment/skill/spell lists
      const res = await fetch('dnd_data.json');
      const dndData = await res.json();

      // Helper to initialize all entries with count 0
      function initEntries(list) {
        return (list || []).map(e => ({ name: e.name, count: 0 }));
      }

      // Stat base
      let stats = {
        strength: randomStat(),
        dexterity: randomStat(),
        constitution: randomStat(),
        intelligence: randomStat(),
        wisdom: randomStat(),
        charisma: randomStat()
      };
      // Apply race bonuses
      if (raceInfo[race] && raceInfo[race].bonus) {
        Object.entries(raceInfo[race].bonus).forEach(([stat, val]) => {
          stats[stat] += val;
        });
      }
      // Apply class bonuses
      if (classInfo[charClass]) {
        if (classInfo[charClass].desc.includes('Strength')) stats.strength += 1;
        if (classInfo[charClass].desc.includes('Dexterity')) stats.dexterity += 1;
        if (classInfo[charClass].desc.includes('Constitution')) stats.constitution += 1;
        if (classInfo[charClass].desc.includes('Intelligence')) stats.intelligence += 1;
        if (classInfo[charClass].desc.includes('Wisdom')) stats.wisdom += 1;
        if (classInfo[charClass].desc.includes('Charisma')) stats.charisma += 1;
      }
      // Skill bonuses
      function addSkillBonus(skills, skillName, amt) {
        const idx = skills.findIndex(s => s.name === skillName);
        if (idx > -1) skills[idx].count += amt;
      }
      let skills = initEntries(dndData.skills);
      // Class skill bonuses
      if (classInfo[charClass]) {
        const match = classInfo[charClass].desc.match(/\+2 ([A-Za-z ]+)/);
        if (match) addSkillBonus(skills, match[1], 2);
      }
      // Background skill proficiencies
      if (backgroundInfo[background] && Array.isArray(backgroundInfo[background].skills)) {
        backgroundInfo[background].skills.forEach(skillName => {
          if (skillName) addSkillBonus(skills, skillName, 2);
        });
      }

      const character = {
        username: username,
        name: name,
        race: race,
        class: charClass,
        background: background,
        level: level,
        strength: stats.strength ?? 0,
        dexterity: stats.dexterity ?? 0,
        constitution: stats.constitution ?? 0,
        intelligence: stats.intelligence ?? 0,
        wisdom: stats.wisdom ?? 0,
        charisma: stats.charisma ?? 0,
        items: Array.isArray(dndData.items) ? initEntries(dndData.items) : [],
        equipment: Array.isArray(dndData.equipment) ? initEntries(dndData.equipment) : [],
        skills: Array.isArray(skills) ? skills : [],
        spells: Array.isArray(dndData.spells) ? initEntries(dndData.spells) : [],
        bio: ''
      };
      // Save to Supabase
      const { data, error } = await supabaseClient.from('characters').insert([character]);
      if (error) {
        alert('Error saving character: ' + error.message);
      } else {
        alert('Character saved to database!');
      }
      generatedBlob = new Blob([JSON.stringify(character, null, 2)], {type: 'application/json'});
      document.getElementById('downloadBtn').style.display = 'inline-block';
    });
    document.getElementById('downloadBtn').addEventListener('click', function() {
      if (generatedBlob) {
        const username = document.getElementById('username').value.trim();
        const name = document.getElementById('name').value.trim();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(generatedBlob);
        a.download = `${username}_${name}.json`;
        a.click();
      }
    });
  </script>
</body>
</html>