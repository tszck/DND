<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GM Character Manager</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="supabase.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #23272a;
      color: #fff;
      margin: 0;
      padding: 0;
    }
    html, body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      min-height: 100vh;
      min-width: 100vw;
      box-sizing: border-box;
    }
    .dashboard {
      width: 100vw;
      min-height: 100vh;
      margin: 0;
      background: #2c2f33;
      border-radius: 0;
      box-shadow: none;
      padding: 32px 2vw 32px 2vw;
      display: flex;
      flex-direction: column;
      gap: 32px;
      box-sizing: border-box;
    }
    .top-row {
      display: flex;
      flex-direction: row;
      gap: 32px;
      width: 100%;
      flex: 0 0 auto;
      min-height: 0;
    }
    .char-selection, .char-preview {
      flex: 1 1 0;
      min-width: 0;
      min-height: 0;
      display: flex;
      flex-direction: column;
      max-width: 48%;
      background: #23272a;
      padding: 24px;
      border-radius: 16px;
      box-sizing: border-box;
      min-height: 400px;
    }
    .bottom-row {
      flex: 0 0 auto;
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 24px;
      width: 100%;
      margin-top: 32px;
    }
    .gm-form-section {
      background: #23272a;
      padding: 24px;
      border-radius: 16px;
      box-sizing: border-box;
      width: 100%;
      margin-bottom: 24px;
    }
    .section-title {
      font-size: 1.2em;
      color: #43b581;
      margin-bottom: 16px;
      border-bottom: 2px solid #43b581;
      display: inline-block;
      padding-bottom: 2px;
    }
    .char-list select {
      width: 100%;
      padding: 12px;
      border-radius: 6px;
      border: none;
      background: #2c2f33;
      color: #fff;
      font-size: 1em;
      margin-top: 8px;
    }
    .avatar-preview {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 4px solid #7289da;
      object-fit: cover;
      display: block;
      margin: 0 auto 16px;
    }
    .gm-form label {
      display: block;
      margin-top: 16px;
      color: #43b581;
      font-weight: 500;
    }
    .gm-form input, .gm-form select, .gm-form textarea {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1px solid #404549;
      background: #2c2f33;
      color: #fff;
      font-size: 1em;
      box-sizing: border-box;
    }
    .gm-form input:focus, .gm-form select:focus, .gm-form textarea:focus {
      outline: none;
      border-color: #7289da;
      box-shadow: 0 0 0 2px rgba(114, 137, 218, 0.2);
    }
    .gm-form textarea {
      resize: vertical;
      min-height: 80px;
    }
    .gm-form button {
      margin-top: 24px;
      padding: 12px 24px;
      background: #7289da;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 500;
      transition: background-color 0.2s;
    }
    .gm-form button:hover {
      background: #677bc4;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-top: 16px;
    }
    .stat-input-group {
      display: flex;
      flex-direction: column;
    }
    .basic-info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-top: 16px;
    }
    /* responsive stack on small screens */
    @media (max-width: 900px) {
      .top-row { flex-direction: column; }
      .char-selection, .char-preview { max-width: 100%; }
      .dashboard { padding: 16px; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .basic-info-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <div class="top-row">
      <!-- Character Selection Block -->
      <div class="char-selection">
        <div class="section-title">Game Master Character Manager</div>
        <div class="char-list">
          <label for="char-select">Select Character:</label>
          <select id="char-select"></select>
        </div>
        
        <!-- Space reserved for additional GM controls -->
        <div style="margin-top: 24px; padding: 16px; border: 2px dashed #404549; border-radius: 8px; text-align: center; color: #72767d;">
          <p>Space reserved for additional GM controls</p>
          <p style="font-size: 0.9em;">Future features: Quick actions, character notes, etc.</p>
        </div>
      </div>
      
      <!-- Character Preview Block -->
      <div class="char-preview">
        <div class="section-title">Character Preview</div>
        <div style="text-align: center;">
          <img id="avatar-preview" src="https://oitwwvjgkmzffsdsodzm.supabase.co/storage/v1/object/public/avatars/avatar.jpg" alt="Avatar Preview" class="avatar-preview">
          <input type="file" id="avatar-upload" accept="image/jpg, image/jpeg" style="margin-bottom: 16px;">
        </div>
        
        <!-- Space reserved for character quick info -->
        <div style="margin-top: 16px; padding: 16px; border: 2px dashed #404549; border-radius: 8px; text-align: center; color: #72767d;">
          <p>Space reserved for character quick info</p>
          <p style="font-size: 0.9em;">Future features: Level, class, quick stats display</p>
        </div>
      </div>
    </div>

    <div class="bottom-row">
      <form id="gmForm" class="gm-form">
        <!-- Basic Information Section -->
        <div class="gm-form-section">
          <div class="section-title">Basic Information</div>
          <div class="basic-info-grid">
            <div>
              <label for="name">Character Name:</label>
              <input type="text" id="name" name="name">
            </div>
            <div>
              <label for="level">Level:</label>
              <input type="number" id="level" name="level" min="1">
            </div>
            <div>
              <label for="race">Race:</label>
              <input type="text" id="race" name="race">
            </div>
            <div>
              <label for="class">Class:</label>
              <input type="text" id="class" name="class">
            </div>
            <div>
              <label for="background">Background:</label>
              <input type="text" id="background" name="background">
            </div>
            <div>
              <label for="xp">XP:</label>
              <input type="number" id="xp" name="xp" min="0">
            </div>
          </div>
        </div>

        <!-- Character Details Section -->
        <div class="gm-form-section">
          <div class="section-title">Character Details</div>
          <label for="bio">Bio / Notes:</label>
          <textarea id="bio" name="bio" rows="3"></textarea>
          
          <label for="story-bio">Story Bio (GM only):</label>
          <textarea id="story-bio" name="story-bio" rows="3"></textarea>
          
          <!-- Space reserved for additional character details -->
          <div style="margin-top: 24px; padding: 16px; border: 2px dashed #404549; border-radius: 8px; text-align: center; color: #72767d;">
            <p>Space reserved for additional character details</p>
            <p style="font-size: 0.9em;">Future features: Backstory, relationships, plot hooks</p>
          </div>
        </div>

        <!-- Stats & Resources Section -->
        <div class="gm-form-section">
          <div class="section-title">Stats & Resources</div>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
            <div>
              <label for="gold">Gold (G):</label>
              <input type="number" id="gold" name="gold" min="0">
            </div>
            <div>
              <label for="free_stat_points">Free Stat Points:</label>
              <input type="number" id="free_stat_points" name="free_stat_points" min="0">
            </div>
          </div>
          
          <div class="section-title" style="margin-top: 24px;">Ability Scores</div>
          <div class="stats-grid">
            <div class="stat-input-group">
              <label for="strength">Strength:</label>
              <input type="number" id="strength" name="strength" min="0">
            </div>
            <div class="stat-input-group">
              <label for="dexterity">Dexterity:</label>
              <input type="number" id="dexterity" name="dexterity" min="0">
            </div>
            <div class="stat-input-group">
              <label for="constitution">Constitution:</label>
              <input type="number" id="constitution" name="constitution" min="0">
            </div>
            <div class="stat-input-group">
              <label for="intelligence">Intelligence:</label>
              <input type="number" id="intelligence" name="intelligence" min="0">
            </div>
            <div class="stat-input-group">
              <label for="wisdom">Wisdom:</label>
              <input type="number" id="wisdom" name="wisdom" min="0">
            </div>
            <div class="stat-input-group">
              <label for="charisma">Charisma:</label>
              <input type="number" id="charisma" name="charisma" min="0">
            </div>
          </div>
          
          <!-- Space reserved for additional stats -->
          <div style="margin-top: 24px; padding: 16px; border: 2px dashed #404549; border-radius: 8px; text-align: center; color: #72767d;">
            <p>Space reserved for additional stats & resources</p>
            <p style="font-size: 0.9em;">Future features: HP, AC, saving throws, skills</p>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="gm-form-section" style="text-align: center;">
          <button type="submit">Save Changes</button>
          
          <!-- Space reserved for additional actions -->
          <div style="margin-top: 24px; padding: 16px; border: 2px dashed #404549; border-radius: 8px; text-align: center; color: #72767d;">
            <p>Space reserved for additional GM actions</p>
            <p style="font-size: 0.9em;">Future features: Delete character, duplicate, export</p>
          </div>
        </div>
      </form>
    </div>
  </div>
  <script>
    let characters = [];
    let selectedChar = null;
    let avatarBlob = null;
    let avatarFileType = null;
    async function fetchCharacters() {
      const { data, error } = await supabaseClient.from('characters').select('*');
      if (error) {
        alert('Failed to fetch characters: ' + error.message);
        return;
      }
      characters = data || [];
      const select = document.getElementById('char-select');
      select.innerHTML = '';
      characters.forEach((char, idx) => {
        const opt = document.createElement('option');
        opt.value = idx;
        opt.textContent = `${char.name || char.username || 'Unnamed'} (${char.username})`;
        select.appendChild(opt);
      });
      if (characters.length > 0) {
        select.value = 0;
        loadCharacter(0);
      }
    }
    function loadCharacter(idx) {
      selectedChar = characters[idx];
      if (!selectedChar) return;
      const avatarImg = document.getElementById('avatar-preview');
      if (avatarImg) {
        const username = selectedChar.username || selectedChar.name || '';
        const canonicalAvatarUrl = `https://oitwwvjgkmzffsdsodzm.supabase.co/storage/v1/object/public/avatars/avatar_${username}.jpg`;
        avatarImg.onerror = function() {
          if (!this.src.endsWith('avatar.jpg')) {
            this.onerror = null;
            this.src = 'https://oitwwvjgkmzffsdsodzm.supabase.co/storage/v1/object/public/avatars/avatar.jpg';
            this.title = 'Avatar could not be loaded. Showing default avatar.';
          }
        };
        avatarImg.src = canonicalAvatarUrl;
        avatarImg.title = selectedChar.avatar_url ? '' : 'No avatar set. Upload or provide a URL.';
      }
      document.getElementById('name').value = selectedChar.name || '';
      document.getElementById('bio').value = selectedChar.bio || '';
      document.getElementById('story-bio').value = selectedChar.story_bio || '';
      document.getElementById('race').value = selectedChar.race || '';
      document.getElementById('class').value = selectedChar.class || '';
      document.getElementById('background').value = selectedChar.background || '';
      document.getElementById('level').value = selectedChar.level || 1;
      document.getElementById('xp').value = selectedChar.xp || 0;
  document.getElementById('gold').value = selectedChar.gold || 0;
      document.getElementById('free_stat_points').value = selectedChar.free_stat_points || 0;
      document.getElementById('strength').value = selectedChar.strength || 0;
      document.getElementById('dexterity').value = selectedChar.dexterity || 0;
      document.getElementById('constitution').value = selectedChar.constitution || 0;
      document.getElementById('intelligence').value = selectedChar.intelligence || 0;
      document.getElementById('wisdom').value = selectedChar.wisdom || 0;
      document.getElementById('charisma').value = selectedChar.charisma || 0;
      avatarBlob = null;
      avatarFileType = null;
    }
    document.getElementById('char-select').addEventListener('change', function(e) {
      loadCharacter(e.target.value);
    });
    document.getElementById('avatar-upload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      if (!['image/jpeg','image/jpg'].includes(file.type)) {
        alert('Only JPEG and jpg images allowed.');
        return;
      }
      if (file.size > 200*1024) {
        alert('Image must be under 200KB.');
        return;
      }
      // Resize image to max 256x256px
      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement('canvas');
        const maxDim = 256;
        let w = img.width, h = img.height;
        if (w > maxDim || h > maxDim) {
          if (w > h) {
            h = Math.round(h * (maxDim / w));
            w = maxDim;
          } else {
            w = Math.round(w * (maxDim / h));
            h = maxDim;
          }
        }
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);
        canvas.toBlob(function(blob) {
          avatarBlob = blob;
          avatarFileType = file.type;
          // Show preview immediately, but also set up fallback logic for canonical avatar
          const avatarImg = document.getElementById('avatar-preview');
          if (avatarImg) {
            avatarImg.onerror = function() {
              if (!this.src.endsWith('avatar.jpg')) {
                this.onerror = null;
                this.src = 'https://oitwwvjgkmzffsdsodzm.supabase.co/storage/v1/object/public/avatars/avatar.jpg';
                this.title = 'Avatar could not be loaded. Showing default avatar.';
              }
            };
            avatarImg.src = canvas.toDataURL(file.type, 0.92);
          }
// Prevent ReferenceError if attachTooltipListeners is missing
if (typeof attachTooltipListeners !== 'function') {
  function attachTooltipListeners() {}
}
        }, file.type, 0.92);
      };
      const reader = new FileReader();
      reader.onload = function(ev) { img.src = ev.target.result; };
      reader.readAsDataURL(file);
    });
    document.getElementById('gmForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      if (!selectedChar) return;
      let avatarUrl = selectedChar.avatar_url || '';
      if (avatarBlob && avatarFileType) {
        const fileExt = avatarFileType === 'image/jpg' ? 'jpg' : 'jpg';
        const fileName = `avatar_${selectedChar.username}.${fileExt}`;
        const { data: uploadData, error: uploadError } = await supabaseClient.storage.from('avatars').upload(fileName, avatarBlob, {
          upsert: true,
          contentType: avatarFileType
        });
        if (uploadError) {
          alert('Avatar upload failed: ' + uploadError.message);
        } else {
          const { publicURL } = supabaseClient.storage.from('avatars').getPublicUrl(fileName);
          avatarUrl = publicURL;
        }
      }
      const updated = {
        name: document.getElementById('name').value.trim(),
        bio: document.getElementById('bio').value.trim(),
        story_bio: document.getElementById('story-bio').value.trim(),
        race: document.getElementById('race').value.trim(),
        class: document.getElementById('class').value.trim(),
        background: document.getElementById('background').value.trim(),
        level: parseInt(document.getElementById('level').value) || 1,
        xp: parseInt(document.getElementById('xp').value) || 0,
        free_stat_points: parseInt(document.getElementById('free_stat_points').value) || 0,
  gold: parseInt(document.getElementById('gold').value) || 0,
        strength: parseInt(document.getElementById('strength').value) || 0,
        dexterity: parseInt(document.getElementById('dexterity').value) || 0,
        constitution: parseInt(document.getElementById('constitution').value) || 0,
        intelligence: parseInt(document.getElementById('intelligence').value) || 0,
        wisdom: parseInt(document.getElementById('wisdom').value) || 0,
        charisma: parseInt(document.getElementById('charisma').value) || 0,
        avatar_url: avatarUrl,
        updated_at: new Date().toISOString()
      };
      // Use the common helper so we get retries and verification, and automatic fallback when
      // the `gold` column is missing on the server.
      const updatedRow = await updateCharacter(selectedChar.username, updated);
      if (!updatedRow) {
        alert('Failed to update character. See console for details.');
      } else {
        alert('Character updated!');
        await fetchCharacters();
      }
    });
    // Only allow access if username is 'gamemaster'
    function checkGM() {
      let username = localStorage.getItem('dnd_username');
      if (!username || username !== 'gamemaster') {
        window.location.href = 'index.html';
      }
    }
    checkGM();
    fetchCharacters();
  </script>
</body>
</html>