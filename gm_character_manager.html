<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GM Character Manager</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="supabase.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #23272a;
      color: #fff;
      margin: 0;
      padding: 0;
    }
    html, body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      min-height: 100vh;
      min-width: 100vw;
      box-sizing: border-box;
    }
    .dashboard {
      width: 100vw;
      min-height: 100vh;
      margin: 0;
      background: #2c2f33;
      border-radius: 0;
      box-shadow: none;
      padding: 32px 2vw 32px 2vw;
      display: flex;
      flex-direction: column;
      gap: 32px;
      box-sizing: border-box;
    }
    .top-row {
      display: flex;
      flex-direction: row;
      gap: 32px;
      width: 100%;
      flex: 0 0 auto;
      min-height: 0;
    }
    .char-selection, .char-preview {
      flex: 1 1 0;
      min-width: 0;
      min-height: 0;
      display: flex;
      flex-direction: column;
      max-width: 48%;
      background: #23272a;
      padding: 24px;
      border-radius: 16px;
      box-sizing: border-box;
      min-height: 400px;
    }
    .bottom-row {
      flex: 0 0 auto;
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 24px;
      width: 100%;
      margin-top: 32px;
    }
    .gm-form-section {
      background: #23272a;
      padding: 24px;
      border-radius: 16px;
      box-sizing: border-box;
      width: 100%;
      margin-bottom: 24px;
    }
    .section-title {
      font-size: 1.2em;
      color: #43b581;
      margin-bottom: 16px;
      border-bottom: 2px solid #43b581;
      display: inline-block;
      padding-bottom: 2px;
    }
    .char-list select {
      width: 100%;
      padding: 12px;
      border-radius: 6px;
      border: none;
      background: #2c2f33;
      color: #fff;
      font-size: 1em;
      margin-top: 8px;
    }
    .avatar-preview {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 4px solid #7289da;
      object-fit: cover;
      display: block;
      margin: 0 auto 16px;
    }
    .gm-form label {
      display: block;
      margin-top: 16px;
      color: #43b581;
      font-weight: 500;
    }
    .gm-form input, .gm-form select, .gm-form textarea {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1px solid #404549;
      background: #2c2f33;
      color: #fff;
      font-size: 1em;
      box-sizing: border-box;
    }
    .gm-form input:focus, .gm-form select:focus, .gm-form textarea:focus {
      outline: none;
      border-color: #7289da;
      box-shadow: 0 0 0 2px rgba(114, 137, 218, 0.2);
    }
    .gm-form textarea {
      resize: vertical;
      min-height: 80px;
    }
    .gm-form button {
      margin-top: 24px;
      padding: 12px 24px;
      background: #7289da;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 500;
      transition: background-color 0.2s;
    }
    .gm-form button:hover {
      background: #677bc4;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-top: 16px;
    }
    .stat-input-group {
      display: flex;
      flex-direction: column;
    }
    .basic-info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-top: 16px;
    }
    /* responsive stack on small screens */
    @media (max-width: 900px) {
      .top-row { flex-direction: column; }
      .char-selection, .char-preview { max-width: 100%; }
      .dashboard { padding: 16px; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .basic-info-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
    <div class="dashboard">
      <!-- Top bulk action and character selection panel -->
      <div style="display:flex;flex-direction:row;gap:32px;width:100%;align-items:flex-start;">
        <div style="flex:2 1 0;min-width:0;">
          <div class="section-title">Game Master Character Manager</div>
          <div id="bulk-action-bar" style="margin-bottom:10px;display:flex;gap:8px;align-items:center;">
            <button type="button" id="bulk-xp-btn">Grant XP</button>
            <button type="button" id="bulk-gold-btn">Grant Gold</button>
            <button type="button" id="bulk-status-btn">Set Status (placeholder)</button>
            <span id="bulk-action-msg" style="color:#43b581;font-size:0.95em;margin-left:8px;"></span>
          </div>
          <div id="char-checkbox-list" style="max-height:220px;overflow-y:auto;border:1px solid #404549;border-radius:6px;padding:8px 0 8px 0;background:#23272a;"></div>
          <div style="margin-top: 16px; padding: 12px; border: 2px dashed #404549; border-radius: 8px; text-align: center; color: #72767d;">
            <p>Bulk actions: Select multiple characters above and use the buttons to grant XP, gold, or status (placeholder).</p>
          </div>
        </div>
        <!-- Character Preview panel removed: avatar will be moved into Basic Information section -->
      </div>

    <div class="bottom-row">
  <form id="gmForm" class="gm-form">
    <!-- Session Log Panel -->
    <div class="gm-form-section" id="session-log-panel" style="background:#202225;margin-top:0;">
      <div class="section-title" style="margin-bottom:8px;">Session Log</div>
      <div id="session-log" style="max-height:120px;overflow-y:auto;font-size:0.97em;background:#18191c;padding:10px 12px;border-radius:8px;color:#ccc;"></div>
    </div>
        <!-- Basic Information Section -->
        <div class="gm-form-section">
          <div class="section-title">Basic Information</div>
          <div style="margin-bottom:16px;">
            <label for="single-char-select">Choose Character:</label>
            <select id="single-char-select" style="width:100%;padding:10px;border-radius:6px;background:#2c2f33;color:#fff;font-size:1em;margin-top:6px;"></select>
          </div>
          <div style="text-align:center;margin-bottom:16px;">
            <img id="avatar-preview" src="https://oitwwvjgkmzffsdsodzm.supabase.co/storage/v1/object/public/avatars/avatar.jpg" alt="Avatar Preview" class="avatar-preview">
            <input type="file" id="avatar-upload" accept="image/jpg, image/jpeg" style="margin-bottom: 8px;display:block;margin-left:auto;margin-right:auto;">
          </div>
          <div class="basic-info-grid">
            <div>
              <label for="name">Character Name:</label>
              <input type="text" id="name" name="name">
            </div>
            <div>
              <label for="level">Level:</label>
              <input type="number" id="level" name="level" min="1">
            </div>
            <div>
              <label for="race">Race:</label>
              <input type="text" id="race" name="race" list="race-suggestions" autocomplete="off">
              <datalist id="race-suggestions">
                <option value="Human">
                <option value="Elf">
                <option value="Dwarf">
                <option value="Halfling">
                <option value="Gnome">
                <option value="Half-Orc">
                <option value="Tiefling">
                <option value="Dragonborn">
              </datalist>
            </div>
            <div>
              <label for="class">Class:</label>
              <input type="text" id="class" name="class" list="class-suggestions" autocomplete="off">
              <datalist id="class-suggestions">
                <option value="Fighter">
                <option value="Wizard">
                <option value="Cleric">
                <option value="Rogue">
                <option value="Ranger">
                <option value="Paladin">
                <option value="Bard">
                <option value="Druid">
                <option value="Barbarian">
                <option value="Monk">
                <option value="Sorcerer">
                <option value="Warlock">
              </datalist>
            </div>
            <div>
              <label for="background">Background:</label>
              <input type="text" id="background" name="background" list="background-suggestions" autocomplete="off">
              <datalist id="background-suggestions">
                <option value="Acolyte">
                <option value="Charlatan">
                <option value="Criminal">
                <option value="Entertainer">
                <option value="Folk Hero">
                <option value="Guild Artisan">
                <option value="Hermit">
                <option value="Noble">
                <option value="Outlander">
                <option value="Sage">
                <option value="Sailor">
                <option value="Soldier">
                <option value="Urchin">
              </datalist>
            </div>
            <div>
              <label for="xp">XP:</label>
              <input type="number" id="xp" name="xp" min="0">
            </div>
          </div>
        </div>

        <!-- Character Details Section -->
        <div class="gm-form-section">
          <div class="section-title">Character Details</div>
          <label for="bio">Bio / Notes:</label>
          <textarea id="bio" name="bio" rows="3"></textarea>
          


          <!-- Status Effects Management -->
          <div style="margin-top:24px;">
            <div class="section-title" style="margin-bottom:8px;">Status Effects</div>
            <div id="status-effects-list" style="margin-bottom:10px;"></div>
            <div style="display:flex;gap:8px;align-items:center;">
              <select id="status-effect-select" style="flex:1;max-width:220px;"></select>
              <button type="button" id="add-status-effect-btn">Add</button>
              <button type="button" id="remove-status-effect-btn">Remove</button>
            </div>
            <div id="status-effect-desc" style="margin-top:6px;color:#b9bbbe;font-size:0.95em;"></div>
          </div>

          <!-- Space reserved for additional character details -->
          <div style="margin-top: 24px; padding: 16px; border: 2px dashed #404549; border-radius: 8px; text-align: center; color: #72767d;">
            <p>Space reserved for additional character details</p>
            <p style="font-size: 0.9em;">Future features: Backstory, relationships, plot hooks</p>
          </div>
        </div>

        <!-- Stats & Resources Section -->
        <div class="gm-form-section">
          <div class="section-title">Stats & Resources</div>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
            <div>
              <label for="gold">Gold (G):</label>
              <input type="number" id="gold" name="gold" min="0">
            </div>

          </div>
          
          <div class="section-title" style="margin-top: 24px;">Stats</div>
          <div class="stats-grid">
            <div class="stat-input-group">
              <label for="strength">Strength:</label>
              <div style="display:flex;align-items:center;gap:0;">
                <button type="button" class="stat-btn" data-stat="strength" data-delta="-1" style="width:32px;height:32px;font-size:1.2em;">-</button>
                <input type="number" id="strength" name="strength" min="0" style="width:80px;height:32px;text-align:center;font-size:1.1em;" readonly>
                <button type="button" class="stat-btn" data-stat="strength" data-delta="1" style="width:32px;height:32px;font-size:1.2em;">+</button>
              </div>
            </div>
            <div class="stat-input-group">
              <label for="dexterity">Dexterity:</label>
              <div style="display:flex;align-items:center;gap:0;">
                <button type="button" class="stat-btn" data-stat="dexterity" data-delta="-1" style="width:32px;height:32px;font-size:1.2em;">-</button>
                <input type="number" id="dexterity" name="dexterity" min="0" style="width:80px;height:32px;text-align:center;font-size:1.1em;" readonly>
                <button type="button" class="stat-btn" data-stat="dexterity" data-delta="1" style="width:32px;height:32px;font-size:1.2em;">+</button>
              </div>
            </div>
            <div class="stat-input-group">
              <label for="constitution">Constitution:</label>
              <div style="display:flex;align-items:center;gap:0;">
                <button type="button" class="stat-btn" data-stat="constitution" data-delta="-1" style="width:32px;height:32px;font-size:1.2em;">-</button>
                <input type="number" id="constitution" name="constitution" min="0" style="width:80px;height:32px;text-align:center;font-size:1.1em;" readonly>
                <button type="button" class="stat-btn" data-stat="constitution" data-delta="1" style="width:32px;height:32px;font-size:1.2em;">+</button>
              </div>
            </div>
            <div class="stat-input-group">
              <label for="intelligence">Intelligence:</label>
              <div style="display:flex;align-items:center;gap:0;">
                <button type="button" class="stat-btn" data-stat="intelligence" data-delta="-1" style="width:32px;height:32px;font-size:1.2em;">-</button>
                <input type="number" id="intelligence" name="intelligence" min="0" style="width:80px;height:32px;text-align:center;font-size:1.1em;" readonly>
                <button type="button" class="stat-btn" data-stat="intelligence" data-delta="1" style="width:32px;height:32px;font-size:1.2em;">+</button>
              </div>
            </div>
            <div class="stat-input-group">
              <label for="wisdom">Wisdom:</label>
              <div style="display:flex;align-items:center;gap:0;">
                <button type="button" class="stat-btn" data-stat="wisdom" data-delta="-1" style="width:32px;height:32px;font-size:1.2em;">-</button>
                <input type="number" id="wisdom" name="wisdom" min="0" style="width:80px;height:32px;text-align:center;font-size:1.1em;" readonly>
                <button type="button" class="stat-btn" data-stat="wisdom" data-delta="1" style="width:32px;height:32px;font-size:1.2em;">+</button>
              </div>
            </div>
            <div class="stat-input-group">
              <label for="charisma">Charisma:</label>
              <div style="display:flex;align-items:center;gap:0;">
                <button type="button" class="stat-btn" data-stat="charisma" data-delta="-1" style="width:32px;height:32px;font-size:1.2em;">-</button>
                <input type="number" id="charisma" name="charisma" min="0" style="width:80px;height:32px;text-align:center;font-size:1.1em;" readonly>
                <button type="button" class="stat-btn" data-stat="charisma" data-delta="1" style="width:32px;height:32px;font-size:1.2em;">+</button>
              </div>
            </div>
          </div>
          
          <!-- Space reserved for additional stats -->
          <div style="margin-top: 24px; padding: 16px; border: 2px dashed #404549; border-radius: 8px; text-align: center; color: #72767d;">
            <p>Space reserved for additional stats & resources</p>
            <p style="font-size: 0.9em;">Future features: HP, AC, saving throws, skills</p>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="gm-form-section" style="text-align: center;">
          <button type="submit">Save Changes</button>
          
          <!-- Space reserved for additional actions -->
          <div style="margin-top: 24px; padding: 16px; border: 2px dashed #404549; border-radius: 8px; text-align: center; color: #72767d;">
            <p>Space reserved for additional GM actions</p>
            <p style="font-size: 0.9em;">Future features: Delete character, duplicate, export</p>
          </div>
        </div>
      </form>
    </div>
  </div>
  <script>
    // --- Bulk Actions and Character List ---
    let selectedCharIndexes = [0];
    function renderCharCheckboxList() {
      const listDiv = document.getElementById('char-checkbox-list');
      listDiv.innerHTML = '';
      characters.forEach((char, idx) => {
        const wrapper = document.createElement('div');
        wrapper.style.display = 'flex';
        wrapper.style.alignItems = 'center';
        wrapper.style.gap = '6px';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = idx;
        cb.checked = selectedCharIndexes.includes(idx);
        cb.addEventListener('change', function() {
          if (cb.checked) {
            if (!selectedCharIndexes.includes(idx)) selectedCharIndexes.push(idx);
          } else {
            selectedCharIndexes = selectedCharIndexes.filter(i => i !== idx);
          }
          // If only one selected, load it
          if (selectedCharIndexes.length === 1) {
            loadCharacter(selectedCharIndexes[0]);
            updateSingleCharSelect(selectedCharIndexes[0]);
          }
        });
        const label = document.createElement('label');
        label.textContent = `${char.name || char.username || 'Unnamed'} (${char.username})`;
        wrapper.appendChild(cb);
        wrapper.appendChild(label);
        listDiv.appendChild(wrapper);
      });
      updateSingleCharSelect(selectedCharIndexes.length === 1 ? selectedCharIndexes[0] : null);
    }

    function renderSingleCharSelect() {
      const select = document.getElementById('single-char-select');
      if (!select) return;
      select.innerHTML = '';
      characters.forEach((char, idx) => {
        const opt = document.createElement('option');
        opt.value = idx;
        opt.textContent = `${char.name || char.username || 'Unnamed'} (${char.username})`;
        select.appendChild(opt);
      });
      // Set selected option to the first selectedCharIndexes[0] if available
      if (selectedCharIndexes.length === 1) {
        select.value = selectedCharIndexes[0];
      }
    }

    function updateSingleCharSelect(idx) {
      const select = document.getElementById('single-char-select');
      if (!select) return;
      if (idx !== null && idx !== undefined) {
        select.value = idx;
      } else {
        select.selectedIndex = -1;
      }
    }
    let characters = [];
    let selectedChar = null;
    let avatarBlob = null;
    let avatarFileType = null;
    async function fetchCharacters() {
      const { data, error } = await supabaseClient.from('characters').select('*');
      if (error) {
        alert('Failed to fetch characters: ' + error.message);
        return;
      }
      characters = data || [];
      selectedCharIndexes = characters.length > 0 ? [0] : [];
      renderCharCheckboxList();
      renderSingleCharSelect();
      if (characters.length > 0) {
        loadCharacter(0);
      }
    }
    // Predefined status effects (can be extended)
    const STATUS_EFFECTS = [
      { name: 'Inspired', desc: 'Advantage on one ability check, attack roll, or saving throw.', buff: '+1d6 to a roll', debuff: '', duration: '1 use', notes: '' },
      { name: 'Bleeding', desc: 'Loses HP each turn until healed.', buff: '', debuff: '-1 HP/turn', duration: 'Until healed', notes: '' },
      { name: 'Poisoned', desc: 'Disadvantage on attack rolls and ability checks.', buff: '', debuff: 'Disadvantage on attacks/checks', duration: 'Varies', notes: '' },
      { name: 'Blessed', desc: 'Add 1d4 to attack rolls and saving throws.', buff: '+1d4 to attacks/saves', debuff: '', duration: '1 min', notes: '' },
      { name: 'Cursed', desc: 'Disadvantage on all rolls.', buff: '', debuff: 'Disadvantage on all rolls', duration: 'Varies', notes: '' },
      { name: 'Stunned', desc: 'Can’t move, can speak only falteringly.', buff: '', debuff: 'No actions/movement', duration: '1 round', notes: '' },
      { name: 'Invisible', desc: 'Cannot be seen without magic.', buff: 'Cannot be targeted', debuff: '', duration: 'Varies', notes: '' },
      { name: 'Frightened', desc: 'Disadvantage on ability checks and attack rolls while source of fear is in line of sight.', buff: '', debuff: 'Disadvantage, cannot approach', duration: 'Varies', notes: '' },
      { name: 'Paralyzed', desc: 'Incapacitated, can’t move or speak.', buff: '', debuff: 'No actions/movement', duration: 'Varies', notes: '' },
      { name: 'Charmed', desc: 'Cannot attack charmer, charmer has advantage on social checks.', buff: '', debuff: 'Cannot attack charmer', duration: 'Varies', notes: '' }
    ];

    function renderStatusEffectsList(effects) {
      const listDiv = document.getElementById('status-effects-list');
      if (!listDiv) return;
      if (!effects || effects.length === 0) {
        listDiv.innerHTML = '<span style="color:#888;">No status effects.</span>';
        return;
      }
      listDiv.innerHTML = effects.map(eff =>
        `<span style="display:inline-block;background:#444;color:#fff;padding:4px 10px;margin:2px 4px 2px 0;border-radius:8px;font-size:0.98em;">${eff.name}${eff.duration ? ` <span style='color:#faa61a;font-size:0.9em;'>(${eff.duration})</span>` : ''}</span>`
      ).join('');
    }

    function updateStatusEffectSelect() {
      const select = document.getElementById('status-effect-select');
      if (!select) return;
      select.innerHTML = '';
      STATUS_EFFECTS.forEach(eff => {
        const opt = document.createElement('option');
        opt.value = eff.name;
        opt.textContent = eff.name;
        select.appendChild(opt);
      });
    }

    function showStatusEffectDesc() {
      const select = document.getElementById('status-effect-select');
      const descDiv = document.getElementById('status-effect-desc');
      if (!select || !descDiv) return;
      const eff = STATUS_EFFECTS.find(e => e.name === select.value);
      if (eff) {
        descDiv.innerHTML = `<b>${eff.name}:</b> ${eff.desc} ${eff.buff ? `<span style='color:#43b581;'>[Buff: ${eff.buff}]</span>` : ''} ${eff.debuff ? `<span style='color:#f04747;'>[Debuff: ${eff.debuff}]</span>` : ''} <span style='color:#faa61a;'>${eff.duration ? `[Duration: ${eff.duration}]` : ''}</span>`;
      } else {
        descDiv.textContent = '';
      }
    }

    function loadCharacter(idx) {
      selectedChar = characters[idx];
      if (!selectedChar) return;
      const avatarImg = document.getElementById('avatar-preview');
      if (avatarImg) {
        const username = selectedChar.username || selectedChar.name || '';
        const canonicalAvatarUrl = `https://oitwwvjgkmzffsdsodzm.supabase.co/storage/v1/object/public/avatars/avatar_${username}.jpg`;
        avatarImg.onerror = function() {
          if (!this.src.endsWith('avatar.jpg')) {
            this.onerror = null;
            this.src = 'https://oitwwvjgkmzffsdsodzm.supabase.co/storage/v1/object/public/avatars/avatar.jpg';
            this.title = 'Avatar could not be loaded. Showing default avatar.';
          }
        };
        avatarImg.src = canonicalAvatarUrl;
        avatarImg.title = selectedChar.avatar_url ? '' : 'No avatar set. Upload or provide a URL.';
      }
      document.getElementById('name').value = selectedChar.name || '';
      document.getElementById('bio').value = selectedChar.bio || '';
      if (document.getElementById('story-bio')) document.getElementById('story-bio').value = selectedChar.story_bio || '';
      // Set text input values directly
      document.getElementById('race').value = selectedChar.race || '';
      document.getElementById('class').value = selectedChar.class || '';
      document.getElementById('background').value = selectedChar.background || '';
      document.getElementById('level').value = selectedChar.level || 1;
      document.getElementById('xp').value = selectedChar.xp || 0;
      document.getElementById('gold').value = selectedChar.gold || 0;
      if (document.getElementById('free_stat_points')) document.getElementById('free_stat_points').value = selectedChar.free_stat_points || 0;
      document.getElementById('strength').value = selectedChar.strength || 0;
      document.getElementById('dexterity').value = selectedChar.dexterity || 0;
      document.getElementById('constitution').value = selectedChar.constitution || 0;
      document.getElementById('intelligence').value = selectedChar.intelligence || 0;
      document.getElementById('wisdom').value = selectedChar.wisdom || 0;
      document.getElementById('charisma').value = selectedChar.charisma || 0;
      avatarBlob = null;
      avatarFileType = null;
      // Status effects
      renderStatusEffectsList(selectedChar.status_effects || []);
      updateStatusEffectSelect();
      showStatusEffectDesc();
    }
    // Status Effects UI logic
    document.addEventListener('DOMContentLoaded', function() {
      // Single character dropdown event
      const singleCharSelect = document.getElementById('single-char-select');
      if (singleCharSelect) {
        singleCharSelect.addEventListener('change', function() {
          const idx = parseInt(this.value);
          if (!isNaN(idx)) {
            selectedCharIndexes = [idx];
            loadCharacter(idx);
            renderCharCheckboxList();
          }
        });
      }
      updateStatusEffectSelect();
      showStatusEffectDesc();
      const select = document.getElementById('status-effect-select');
      if (select) {
        select.addEventListener('change', showStatusEffectDesc);
      }
      const addBtn = document.getElementById('add-status-effect-btn');
      if (addBtn) {
        addBtn.addEventListener('click', async function() {
          if (!selectedChar) return;
          const effName = document.getElementById('status-effect-select').value;
          const eff = STATUS_EFFECTS.find(e => e.name === effName);
          if (!eff) return;
          let effects = Array.isArray(selectedChar.status_effects) ? [...selectedChar.status_effects] : [];
          if (effects.find(e => e.name === eff.name)) {
            alert('Effect already present.');
            return;
          }
          effects.push({ ...eff });
          const updated = await updateCharacter(selectedChar.username, { status_effects: effects });
          if (updated) {
            selectedChar.status_effects = effects;
            renderStatusEffectsList(effects);
            addSessionLog(`Added status effect: ${eff.name}`, selectedChar);
          }
        });
      }
      const removeBtn = document.getElementById('remove-status-effect-btn');
      if (removeBtn) {
        removeBtn.addEventListener('click', async function() {
          if (!selectedChar) return;
          const effName = document.getElementById('status-effect-select').value;
          let effects = Array.isArray(selectedChar.status_effects) ? [...selectedChar.status_effects] : [];
          const idx = effects.findIndex(e => e.name === effName);
          if (idx === -1) {
            alert('Effect not present.');
            return;
          }
          effects.splice(idx, 1);
          const updated = await updateCharacter(selectedChar.username, { status_effects: effects });
          if (updated) {
            selectedChar.status_effects = effects;
            renderStatusEffectsList(effects);
            addSessionLog(`Removed status effect: ${effName}`, selectedChar);
          }
        });
      }
    });
    // No longer needed: char-select dropdown
    // Quick Stat Adjustment Buttons
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('stat-btn')) {
        const stat = e.target.getAttribute('data-stat');
        const delta = parseInt(e.target.getAttribute('data-delta'));
        const input = document.getElementById(stat);
        if (input) {
          let val = parseInt(input.value) || 0;
          val += delta;
          if (val < 0) val = 0;
          input.value = val;
          addSessionLog(`Adjusted ${stat} by ${delta > 0 ? '+' : ''}${delta}. New value: ${val}`, selectedChar);
        }
      }
    });

    // --- Session Log ---
    let sessionLog = [];
    function addSessionLog(msg, char) {
      const now = new Date();
      const time = now.toLocaleTimeString();
      let charLabel = '';
      if (char && (char.name || char.username)) {
        charLabel = ` [${char.name || char.username}]`;
      } else if (selectedChar && (selectedChar.name || selectedChar.username)) {
        charLabel = ` [${selectedChar.name || selectedChar.username}]`;
      }
      sessionLog.unshift(`[${time}]${charLabel} ${msg}`);
      if (sessionLog.length > 50) sessionLog = sessionLog.slice(0, 50);
      renderSessionLog();
    }
    function renderSessionLog() {
      document.getElementById('session-log').innerHTML = sessionLog.map(e => `<div>${e}</div>`).join('');
    }

    // --- Bulk Action Buttons ---
    document.getElementById('bulk-xp-btn').addEventListener('click', async function() {
      const amt = prompt('Grant how much XP to selected characters?');
      const xp = parseInt(amt);
      if (isNaN(xp) || xp === 0) return;
      for (const idx of selectedCharIndexes) {
        const char = characters[idx];
        if (!char) continue;
        const newXP = (char.xp || 0) + xp;
        await supabaseClient.from('characters').update({ xp: newXP, updated_at: new Date().toISOString() }).eq('username', char.username);
        addSessionLog(`Granted ${xp} XP to ${char.name || char.username}`);
      }
      await fetchCharacters();
      document.getElementById('bulk-action-msg').textContent = `Granted ${xp} XP to selected.`;
      setTimeout(()=>{document.getElementById('bulk-action-msg').textContent='';},2000);
    });
    document.getElementById('bulk-gold-btn').addEventListener('click', async function() {
      const amt = prompt('Grant how much gold to selected characters?');
      const gold = parseInt(amt);
      if (isNaN(gold) || gold === 0) return;
      for (const idx of selectedCharIndexes) {
        const char = characters[idx];
        if (!char) continue;
        const newGold = (char.gold || 0) + gold;
        await supabaseClient.from('characters').update({ gold: newGold, updated_at: new Date().toISOString() }).eq('username', char.username);
        addSessionLog(`Granted ${gold} gold to ${char.name || char.username}`);
      }
      await fetchCharacters();
      document.getElementById('bulk-action-msg').textContent = `Granted ${gold} gold to selected.`;
      setTimeout(()=>{document.getElementById('bulk-action-msg').textContent='';},2000);
    });
    document.getElementById('bulk-status-btn').addEventListener('click', function() {
      alert('Status bulk action coming soon!');
      addSessionLog('Bulk status action placeholder triggered.');
    });
  sessionLog = [];
  renderSessionLog();
    document.getElementById('avatar-upload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      if (!['image/jpeg','image/jpg'].includes(file.type)) {
        alert('Only JPEG and jpg images allowed.');
        return;
      }
      if (file.size > 200*1024) {
        alert('Image must be under 200KB.');
        return;
      }
      // Resize image to max 256x256px
      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement('canvas');
        const maxDim = 256;
        let w = img.width, h = img.height;
        if (w > maxDim || h > maxDim) {
          if (w > h) {
            h = Math.round(h * (maxDim / w));
            w = maxDim;
          } else {
            w = Math.round(w * (maxDim / h));
            h = maxDim;
          }
        }
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);
        canvas.toBlob(function(blob) {
          avatarBlob = blob;
          avatarFileType = file.type;
          // Show preview immediately, but also set up fallback logic for canonical avatar
          const avatarImg = document.getElementById('avatar-preview');
          if (avatarImg) {
            avatarImg.onerror = function() {
              if (!this.src.endsWith('avatar.jpg')) {
                this.onerror = null;
                this.src = 'https://oitwwvjgkmzffsdsodzm.supabase.co/storage/v1/object/public/avatars/avatar.jpg';
                this.title = 'Avatar could not be loaded. Showing default avatar.';
              }
            };
            avatarImg.src = canvas.toDataURL(file.type, 0.92);
          }
// Prevent ReferenceError if attachTooltipListeners is missing
if (typeof attachTooltipListeners !== 'function') {
  function attachTooltipListeners() {}
}
        }, file.type, 0.92);
      };
      const reader = new FileReader();
      reader.onload = function(ev) { img.src = ev.target.result; };
      reader.readAsDataURL(file);
    });
    document.getElementById('gmForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      if (!selectedChar) return;
      let avatarUrl = selectedChar.avatar_url || '';
      if (avatarBlob && avatarFileType) {
        const fileExt = avatarFileType === 'image/jpg' ? 'jpg' : 'jpg';
        const fileName = `avatar_${selectedChar.username}.${fileExt}`;
        const { data: uploadData, error: uploadError } = await supabaseClient.storage.from('avatars').upload(fileName, avatarBlob, {
          upsert: true,
          contentType: avatarFileType
        });
        if (uploadError) {
          alert('Avatar upload failed: ' + uploadError.message);
        } else {
          const { publicURL } = supabaseClient.storage.from('avatars').getPublicUrl(fileName);
          avatarUrl = publicURL;
        }
      }
      // Get race/class/background from dropdown or custom
      let race = document.getElementById('race').value;
      if (race === 'Other') race = document.getElementById('race-other').value.trim();
      let charClass = document.getElementById('class').value;
      if (charClass === 'Other') charClass = document.getElementById('class-other').value.trim();
      let background = document.getElementById('background').value;
      if (background === 'Other') background = document.getElementById('background-other').value.trim();
      const updated = {
        name: document.getElementById('name').value.trim(),
        bio: document.getElementById('bio').value.trim(),
        race: race,
        class: charClass,
        background: background,
        level: parseInt(document.getElementById('level').value) || 1,
        xp: parseInt(document.getElementById('xp').value) || 0,
        gold: parseInt(document.getElementById('gold').value) || 0,
        strength: parseInt(document.getElementById('strength').value) || 0,
        dexterity: parseInt(document.getElementById('dexterity').value) || 0,
        constitution: parseInt(document.getElementById('constitution').value) || 0,
        intelligence: parseInt(document.getElementById('intelligence').value) || 0,
        wisdom: parseInt(document.getElementById('wisdom').value) || 0,
        charisma: parseInt(document.getElementById('charisma').value) || 0,
        avatar_url: avatarUrl,
        updated_at: new Date().toISOString()
      };
// --- Race/Class/Background Custom Field Logic ---
document.addEventListener('DOMContentLoaded', function() {
  // Race custom field
  const raceSel = document.getElementById('race');
  const raceOther = document.getElementById('race-other');
  if (raceSel && raceOther) {
    raceSel.addEventListener('change', function() {
      if (raceSel.value === 'Other') {
        raceOther.style.display = '';
      } else {
        raceOther.style.display = 'none';
        raceOther.value = '';
      }
    });
  }
  // Class custom field
  const classSel = document.getElementById('class');
  const classOther = document.getElementById('class-other');
  if (classSel && classOther) {
    classSel.addEventListener('change', function() {
      if (classSel.value === 'Other') {
        classOther.style.display = '';
      } else {
        classOther.style.display = 'none';
        classOther.value = '';
      }
    });
  }
  // Background custom field
  const backgroundSel = document.getElementById('background');
  const backgroundOther = document.getElementById('background-other');
  if (backgroundSel && backgroundOther) {
    backgroundSel.addEventListener('change', function() {
      if (backgroundSel.value === 'Other') {
        backgroundOther.style.display = '';
      } else {
        backgroundOther.style.display = 'none';
        backgroundOther.value = '';
      }
    });
  }
});
      // Use the common helper so we get retries and verification, and automatic fallback when
      // the `gold` column is missing on the server.
      const updatedRow = await updateCharacter(selectedChar.username, updated);
      if (!updatedRow) {
        alert('Failed to update character. See console for details.');
      } else {
        alert('Character updated!');
        await fetchCharacters();
      }
    });
    // Only allow access if username is 'gamemaster'
    function checkGM() {
      let username = localStorage.getItem('dnd_username');
      if (!username || username !== 'gamemaster') {
        window.location.href = 'index.html';
      }
    }
    checkGM();
      // No longer needed: char-select dropdown
    fetchCharacters();
  </script>
</body>
</html>