<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Database Migration Quick Fix</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #36393f; color: #dcddde; }
    .container { max-width: 800px; margin: 0 auto; }
    .section { margin: 20px 0; padding: 15px; background: #2f3136; border-radius: 8px; }
    .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
    .success { background: #43b581; }
    .warning { background: #faa61a; }
    .error { background: #f04747; }
    .info { background: #7289da; }
    button { background: #7289da; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
    button:hover { background: #677bc4; }
    .sql-box { background: #40444b; color: #dcddde; border: 1px solid #72767d; padding: 15px; border-radius: 8px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; font-size: 14px; }
    .copy-btn { background: #43b581; font-size: 12px; padding: 5px 10px; }
    h2 { color: #7289da; }
    .step { margin: 15px 0; padding: 15px; border-left: 4px solid #43b581; background: #40444b; }
    .problem { background: #f04747; color: white; padding: 15px; border-radius: 8px; margin: 10px 0; }
    .solution { background: #43b581; color: white; padding: 15px; border-radius: 8px; margin: 10px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üö® Database Migration Fix</h1>
    
    <div class="problem">
      <h2>‚ùå Problem Identified:</h2>
      <p>Your Supabase database is missing critical columns that were added in recent updates:</p>
      <ul>
        <li><strong>race</strong> - Character race (Human, Elf, etc.)</li>
        <li><strong>background</strong> - Character background (Soldier, etc.)</li>
        <li><strong>xp</strong> - Experience points for leveling</li>
        <li><strong>created_at/updated_at</strong> - Timestamps</li>
        <li>All ability scores are <strong>NULL</strong> instead of having values</li>
        <li>All arrays (items, equipment, skills, spells) are <strong>NULL</strong></li>
      </ul>
    </div>

    <div class="solution">
      <h2>‚úÖ Solution:</h2>
      <p>Run this SQL script in your Supabase dashboard to fix everything at once!</p>
    </div>

    <div class="section">
      <h2>üõ†Ô∏è Complete Migration Script</h2>
      <button class="copy-btn" onclick="copyToClipboard()">üìã Copy SQL Script</button>
      <div id="sql-script" class="sql-box">-- Complete D&D Database Migration Script
-- This fixes all missing variables and null values
-- Run this in your Supabase SQL Editor

-- Step 1: Add missing columns safely
ALTER TABLE characters 
ADD COLUMN IF NOT EXISTS race VARCHAR(50),
ADD COLUMN IF NOT EXISTS background VARCHAR(50),
ADD COLUMN IF NOT EXISTS xp INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
ADD COLUMN IF NOT EXISTS updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW();

-- Step 2: Fix NULL ability scores with sensible defaults
UPDATE characters 
SET 
  strength = COALESCE(strength, 10),
  dexterity = COALESCE(dexterity, 10),
  constitution = COALESCE(constitution, 10),
  intelligence = COALESCE(intelligence, 10),
  wisdom = COALESCE(wisdom, 10),
  charisma = COALESCE(charisma, 10)
WHERE strength IS NULL OR dexterity IS NULL OR constitution IS NULL 
   OR intelligence IS NULL OR wisdom IS NULL OR charisma IS NULL;

-- Step 3: Fix NULL arrays with empty JSON arrays
UPDATE characters 
SET 
  items = COALESCE(items, '[]'::jsonb),
  equipment = COALESCE(equipment, '[]'::jsonb),
  skills = COALESCE(skills, '[]'::jsonb),
  spells = COALESCE(spells, '[]'::jsonb)
WHERE items IS NULL OR equipment IS NULL OR skills IS NULL OR spells IS NULL;

-- Step 4: Set default race/background for existing characters
UPDATE characters 
SET 
  race = COALESCE(race, 'Human'),
  background = COALESCE(background, 'Folk Hero'),
  xp = COALESCE(xp, 0),
  bio = COALESCE(bio, 'An adventurer with a mysterious past.'),
  created_at = COALESCE(created_at, NOW()),
  updated_at = COALESCE(updated_at, NOW())
WHERE race IS NULL OR background IS NULL OR xp IS NULL 
   OR bio IS NULL OR created_at IS NULL OR updated_at IS NULL;

-- Step 5: Set column defaults to prevent future NULLs
ALTER TABLE characters 
ALTER COLUMN strength SET DEFAULT 10,
ALTER COLUMN dexterity SET DEFAULT 10,
ALTER COLUMN constitution SET DEFAULT 10,
ALTER COLUMN intelligence SET DEFAULT 10,
ALTER COLUMN wisdom SET DEFAULT 10,
ALTER COLUMN charisma SET DEFAULT 10,
ALTER COLUMN items SET DEFAULT '[]'::jsonb,
ALTER COLUMN equipment SET DEFAULT '[]'::jsonb,
ALTER COLUMN skills SET DEFAULT '[]'::jsonb,
ALTER COLUMN spells SET DEFAULT '[]'::jsonb,
ALTER COLUMN bio SET DEFAULT '',
ALTER COLUMN xp SET DEFAULT 0,
ALTER COLUMN race SET DEFAULT 'Human',
ALTER COLUMN background SET DEFAULT 'Folk Hero';

-- Step 6: Create auto-update trigger for timestamps
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

DROP TRIGGER IF EXISTS update_characters_updated_at ON characters;
CREATE TRIGGER update_characters_updated_at 
    BEFORE UPDATE ON characters 
    FOR EACH ROW 
    EXECUTE FUNCTION update_updated_at_column();

-- Step 7: Verify the migration worked
SELECT 
  username, 
  name, 
  race, 
  background, 
  level, 
  xp,
  strength, 
  dexterity, 
  constitution, 
  intelligence, 
  wisdom, 
  charisma,
  CASE WHEN items IS NOT NULL THEN jsonb_array_length(items) ELSE 0 END as items_count,
  CASE WHEN equipment IS NOT NULL THEN jsonb_array_length(equipment) ELSE 0 END as equipment_count,
  CASE WHEN skills IS NOT NULL THEN jsonb_array_length(skills) ELSE 0 END as skills_count,
  CASE WHEN spells IS NOT NULL THEN jsonb_array_length(spells) ELSE 0 END as spells_count,
  created_at,
  updated_at
FROM characters
ORDER BY username;</div>
    </div>

    <div class="section">
      <h2>üìã How to Apply This Fix:</h2>
      <div class="step">
        <h3>1. Copy the SQL Script</h3>
        <p>Click the "üìã Copy SQL Script" button above</p>
      </div>
      <div class="step">
        <h3>2. Open Supabase Dashboard</h3>
        <p>Go to <strong>https://supabase.com/dashboard</strong> and select your project</p>
      </div>
      <div class="step">
        <h3>3. Navigate to SQL Editor</h3>
        <p>Click <strong>"SQL Editor"</strong> in the left sidebar</p>
      </div>
      <div class="step">
        <h3>4. Create New Query</h3>
        <p>Click <strong>"New Query"</strong> and paste the SQL script</p>
      </div>
      <div class="step">
        <h3>5. Run the Migration</h3>
        <p>Click <strong>"Run"</strong> to execute the script</p>
      </div>
      <div class="step">
        <h3>6. Verify Success</h3>
        <p>The last SELECT statement will show all your characters with complete data</p>
      </div>
    </div>

    <div class="section">
      <h2>‚úÖ What This Fix Does:</h2>
      <ul>
        <li>‚úÖ Adds missing <strong>race</strong>, <strong>background</strong>, <strong>xp</strong> columns</li>
        <li>‚úÖ Fixes all NULL ability scores (sets to 10 - average human)</li>
        <li>‚úÖ Converts NULL arrays to empty arrays</li>
        <li>‚úÖ Sets reasonable defaults for existing characters</li>
        <li>‚úÖ Adds timestamps for tracking changes</li>
        <li>‚úÖ Prevents future NULL values with column defaults</li>
        <li>‚úÖ Creates automatic timestamp updates</li>
        <li>‚úÖ Verifies everything worked correctly</li>
      </ul>
    </div>

    <div id="copy-result"></div>
  </div>

  <script>
    function copyToClipboard() {
      const element = document.getElementById('sql-script');
      const text = element.textContent;
      
      // Try modern clipboard API first
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => {
          showCopySuccess();
        }).catch(() => {
          fallbackCopy(element);
        });
      } else {
        // Fallback for older browsers or non-HTTPS
        fallbackCopy(element);
      }
    }
    
    function showCopySuccess() {
      const resultDiv = document.getElementById('copy-result');
      resultDiv.innerHTML = '<div class="result success">üìã SQL script copied to clipboard! Now paste it in your Supabase SQL Editor.</div>';
      setTimeout(() => {
        resultDiv.innerHTML = '';
      }, 5000);
    }
    
    function fallbackCopy(element) {
      try {
        // Select the text
        const range = document.createRange();
        range.selectNode(element);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        
        // Try to copy
        const success = document.execCommand('copy');
        window.getSelection().removeAllRanges();
        
        if (success) {
          showCopySuccess();
        } else {
          showCopyError();
        }
      } catch (err) {
        showCopyError();
      }
    }
    
    function showCopyError() {
      const resultDiv = document.getElementById('copy-result');
      resultDiv.innerHTML = '<div class="result error">‚ùå Auto-copy failed. The text above is selected - please press Ctrl+C to copy manually.</div>';
    }
  </script>
</body>
</html>