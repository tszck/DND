<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supabase Database Migration Helper</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #36393f; color: #dcddde; }
    .container { max-width: 1000px; margin: 0 auto; }
    .section { margin: 20px 0; padding: 15px; background: #2f3136; border-radius: 8px; }
    .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
    .success { background: #43b581; }
    .warning { background: #faa61a; }
    .error { background: #f04747; }
    .info { background: #7289da; }
    button { background: #7289da; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
    button:hover { background: #677bc4; }
    .sql-box { background: #40444b; color: #dcddde; border: 1px solid #72767d; padding: 15px; border-radius: 8px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
    .copy-btn { background: #43b581; font-size: 12px; padding: 5px 10px; }
    h2 { color: #7289da; }
    h3 { color: #43b581; }
    .step { margin: 15px 0; padding: 10px; border-left: 4px solid #7289da; background: #40444b; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="container">
    <h1>üõ†Ô∏è Supabase Database Migration Helper</h1>
    <p>This tool will help you test your current database and apply the necessary fixes.</p>
    
    <div class="section">
      <h2>Step 1: Test Current Database</h2>
      <button onclick="testCurrentDatabase()">üîç Test Current Database</button>
      <div id="test-results"></div>
    </div>

    <div class="section">
      <h2>Step 2: Migration SQL Script</h2>
      <p>Copy this SQL script and run it in your Supabase SQL Editor:</p>
      <button class="copy-btn" onclick="copyToClipboard('migration-sql')">üìã Copy SQL</button>
      <div id="migration-sql" class="sql-box">-- Migration Script: Add Missing Columns and Fix Existing Data
-- Run this in your Supabase SQL Editor

-- Step 1: Add missing columns (if they don't exist)
ALTER TABLE characters 
ADD COLUMN IF NOT EXISTS race VARCHAR(50),
ADD COLUMN IF NOT EXISTS background VARCHAR(50),
ADD COLUMN IF NOT EXISTS xp INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
ADD COLUMN IF NOT EXISTS updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW();

-- Step 2: Fix null ability scores with default values
UPDATE characters 
SET 
  strength = COALESCE(strength, 8),
  dexterity = COALESCE(dexterity, 8),
  constitution = COALESCE(constitution, 8),
  intelligence = COALESCE(intelligence, 8),
  wisdom = COALESCE(wisdom, 8),
  charisma = COALESCE(charisma, 8)
WHERE strength IS NULL OR dexterity IS NULL OR constitution IS NULL 
   OR intelligence IS NULL OR wisdom IS NULL OR charisma IS NULL;

-- Step 3: Fix null arrays with empty arrays
UPDATE characters 
SET 
  items = COALESCE(items, '[]'::jsonb),
  equipment = COALESCE(equipment, '[]'::jsonb),
  skills = COALESCE(skills, '[]'::jsonb),
  spells = COALESCE(spells, '[]'::jsonb)
WHERE items IS NULL OR equipment IS NULL OR skills IS NULL OR spells IS NULL;

-- Step 4: Set default values for missing fields
UPDATE characters 
SET 
  race = COALESCE(race, 'Human'),
  background = COALESCE(background, 'Folk Hero'),
  xp = COALESCE(xp, 0),
  bio = COALESCE(bio, ''),
  created_at = COALESCE(created_at, NOW()),
  updated_at = COALESCE(updated_at, NOW())
WHERE race IS NULL OR background IS NULL OR xp IS NULL 
   OR bio IS NULL OR created_at IS NULL OR updated_at IS NULL;

-- Step 5: Add constraints to prevent future null values
ALTER TABLE characters 
ALTER COLUMN strength SET DEFAULT 8,
ALTER COLUMN dexterity SET DEFAULT 8,
ALTER COLUMN constitution SET DEFAULT 8,
ALTER COLUMN intelligence SET DEFAULT 8,
ALTER COLUMN wisdom SET DEFAULT 8,
ALTER COLUMN charisma SET DEFAULT 8,
ALTER COLUMN items SET DEFAULT '[]'::jsonb,
ALTER COLUMN equipment SET DEFAULT '[]'::jsonb,
ALTER COLUMN skills SET DEFAULT '[]'::jsonb,
ALTER COLUMN spells SET DEFAULT '[]'::jsonb,
ALTER COLUMN bio SET DEFAULT '',
ALTER COLUMN xp SET DEFAULT 0;

-- Step 6: Create the update trigger (if it doesn't exist)
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

DROP TRIGGER IF EXISTS update_characters_updated_at ON characters;
CREATE TRIGGER update_characters_updated_at 
    BEFORE UPDATE ON characters 
    FOR EACH ROW 
    EXECUTE FUNCTION update_updated_at_column();</div>
    </div>

    <div class="section">
      <h2>Step 3: Verify Migration</h2>
      <button onclick="verifyMigration()">‚úÖ Verify Migration Success</button>
      <div id="verify-results"></div>
    </div>

    <div class="section">
      <h2>Step 4: Migration Instructions</h2>
      <div class="step">
        <h3>üî∏ How to Apply the Migration:</h3>
        <ol>
          <li>Go to your <strong>Supabase Dashboard</strong></li>
          <li>Navigate to <strong>SQL Editor</strong></li>
          <li>Click <strong>"New Query"</strong></li>
          <li>Copy the SQL script above and paste it</li>
          <li>Click <strong>"Run"</strong> to execute</li>
          <li>Come back here and click "Verify Migration Success"</li>
        </ol>
      </div>
    </div>
  </div>

  <script src="supabase.js"></script>
  <script>
    // Check if Supabase is properly initialized
    function checkSupabaseConnection() {
      try {
        if (typeof window.supabase === 'undefined') {
          throw new Error('Supabase library not loaded');
        }
        if (typeof window.fetchCharacter === 'undefined') {
          throw new Error('Supabase client not initialized');
        }
        return true;
      } catch (error) {
        return error.message;
      }
    }

    function logResult(containerId, message, type = 'info') {
      const container = document.getElementById(containerId);
      const div = document.createElement('div');
      div.className = `result ${type}`;
      div.innerHTML = message;
      container.appendChild(div);
    }

    function clearResults(containerId) {
      document.getElementById(containerId).innerHTML = '';
    }

    function copyToClipboard(elementId) {
      const element = document.getElementById(elementId);
      const text = element.textContent;
      navigator.clipboard.writeText(text).then(() => {
        // Create a temporary success message near the copy button
        const copyBtn = document.querySelector('.copy-btn');
        const originalText = copyBtn.textContent;
        copyBtn.textContent = '‚úÖ Copied!';
        copyBtn.style.background = '#43b581';
        setTimeout(() => {
          copyBtn.textContent = originalText;
          copyBtn.style.background = '#43b581';
        }, 2000);
      }).catch((err) => {
        // Fallback for browsers that don't support clipboard API
        const copyBtn = document.querySelector('.copy-btn');
        const originalText = copyBtn.textContent;
        copyBtn.textContent = '‚ùå Copy failed - select text manually';
        copyBtn.style.background = '#f04747';
        setTimeout(() => {
          copyBtn.textContent = originalText;
          copyBtn.style.background = '#43b581';
        }, 3000);
        
        // Select the text as fallback
        const range = document.createRange();
        range.selectNode(element);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
      });
    }

    async function testCurrentDatabase() {
      clearResults('test-results');
      logResult('test-results', 'üîç Testing current database structure...', 'info');
      
      // Check Supabase connection first
      const connectionCheck = checkSupabaseConnection();
      if (connectionCheck !== true) {
        logResult('test-results', `‚ùå Supabase connection error: ${connectionCheck}`, 'error');
        logResult('test-results', 'üí° Make sure supabase.js is properly configured with your database credentials', 'warning');
        return;
      }
      
      logResult('test-results', '‚úÖ Supabase connection established', 'success');
      
      try {
        // Test with existing user
        const character = await fetchCharacter('arin');
        
        if (!character) {
          logResult('test-results', '‚ùå Test character "arin" not found in database', 'error');
          return;
        }
        
        logResult('test-results', `‚úÖ Found character: ${character.name}`, 'success');
        
        const expectedVars = [
          'username', 'name', 'race', 'class', 'background', 'level', 'xp',
          'strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma',
          'items', 'equipment', 'skills', 'spells', 'bio', 'created_at', 'updated_at'
        ];
        
        const results = { present: [], missing: [], null: [] };
        
        expectedVars.forEach(varName => {
          if (character.hasOwnProperty(varName)) {
            if (character[varName] === null || character[varName] === undefined) {
              results.null.push(varName);
            } else {
              results.present.push(varName);
            }
          } else {
            results.missing.push(varName);
          }
        });
        
        if (results.present.length > 0) {
          logResult('test-results', `‚úÖ Present variables (${results.present.length}): ${results.present.join(', ')}`, 'success');
        }
        
        if (results.null.length > 0) {
          logResult('test-results', `‚ö†Ô∏è Null variables (${results.null.length}): ${results.null.join(', ')}`, 'warning');
        }
        
        if (results.missing.length > 0) {
          logResult('test-results', `‚ùå Missing variables (${results.missing.length}): ${results.missing.join(', ')}`, 'error');
        }

        // Overall assessment
        if (results.missing.length === 0 && results.null.length === 0) {
          logResult('test-results', 'üéâ Database is fully migrated! All variables present.', 'success');
        } else {
          logResult('test-results', 'üîß Database needs migration. Please apply the SQL script below.', 'warning');
        }
        
      } catch (error) {
        logResult('test-results', `‚ùå Error testing database: ${error.message}`, 'error');
      }
    }

    async function verifyMigration() {
      clearResults('verify-results');
      logResult('verify-results', 'üîç Verifying migration was successful...', 'info');
      
      // Check Supabase connection first
      const connectionCheck = checkSupabaseConnection();
      if (connectionCheck !== true) {
        logResult('verify-results', `‚ùå Supabase connection error: ${connectionCheck}`, 'error');
        return;
      }
      
      try {
        // Test multiple characters to ensure migration worked
        const testUsers = ['arin', 'borin', 'celeste'];
        let allGood = true;
        
        for (const username of testUsers) {
          const character = await fetchCharacter(username);
          
          if (!character) {
            logResult('verify-results', `‚ùå Character ${username} not found`, 'error');
            allGood = false;
            continue;
          }
          
          // Check critical variables
          const criticalVars = ['race', 'background', 'xp', 'strength', 'items'];
          const missing = criticalVars.filter(v => character[v] === null || character[v] === undefined);
          
          if (missing.length === 0) {
            logResult('verify-results', `‚úÖ ${character.name} (${username}): All variables present`, 'success');
          } else {
            logResult('verify-results', `‚ùå ${character.name} (${username}): Missing ${missing.join(', ')}`, 'error');
            allGood = false;
          }
        }
        
        if (allGood) {
          logResult('verify-results', 'üéâ Migration successful! All characters have complete data.', 'success');
          logResult('verify-results', '‚úÖ Your D&D character management system is ready to use!', 'success');
        } else {
          logResult('verify-results', '‚ö†Ô∏è Migration incomplete. Please re-run the SQL script.', 'warning');
        }
        
      } catch (error) {
        logResult('verify-results', `‚ùå Error verifying migration: ${error.message}`, 'error');
      }
    }

    // Auto-test on page load
    window.addEventListener('load', () => {
      setTimeout(testCurrentDatabase, 1000);
    });
  </script>
</body>
</html>